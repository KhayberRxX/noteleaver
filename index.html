<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>META-ENGINE ULTIMATE | PRO-PROCESSED</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-green: #00ff88;
            --neon-blue: #00d4ff;
            --neon-red: #ff3366;
            --bg-deep: #020202;
            --glass: rgba(15, 15, 15, 0.85);
            --border-glow: rgba(0, 255, 136, 0.2);
            --font-main: 'Inter', sans-serif;
            --font-tech: 'Orbitron', sans-serif;
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        body { 
            background: var(--bg-deep); 
            color: white; 
            font-family: var(--font-main); 
            overflow: hidden; 
            width: 100vw; height: 100vh;
        }

        /* --- ENGINE VIEWPORT --- */
        #world { 
            position: absolute; inset: 0; 
            cursor: crosshair; 
            perspective: 1000px;
            z-index: 1;
        }
        #camera { 
            position: absolute; 
            transform-origin: 0 0; 
            will-change: transform;
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); /* Yumuşak Işınlanma */
        }

        /* Sonsuz Grid Efekti */
        .grid-plane {
            position: absolute;
            width: 1000000px; height: 1000000px;
            left: -500000px; top: -500000px;
            background-image: 
                linear-gradient(rgba(0, 255, 136, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 136, 0.05) 1px, transparent 1px);
            background-size: 100px 100px;
            pointer-events: none;
        }

        /* --- USER PHANTOMS (DİĞER OYUNCULAR) --- */
        .phantom {
            position: absolute;
            width: 12px; height: 12px;
            background: var(--neon-blue);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--neon-blue);
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 50;
        }
        .phantom-label {
            position: absolute; top: -20px; left: 50%;
            transform: translateX(-50%);
            font-size: 10px; font-family: var(--font-tech);
            color: var(--neon-blue); white-space: nowrap;
        }

        /* --- MODERN ENTITIES --- */
        .entity {
            position: absolute; width: 280px;
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            animation: entitySpawn 0.5s var(--ease-out);
        }
        @keyframes entitySpawn { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        .entity:hover { border-color: var(--neon-green); box-shadow: 0 0 20px var(--border-glow); }
        .entity h3 { font-family: var(--font-tech); font-size: 12px; color: var(--neon-green); margin-bottom: 10px; display:flex; justify-content:space-between; }
        .entity p { font-size: 14px; color: #eee; line-height: 1.6; }

        .type-library { border-top: 4px solid var(--neon-blue); cursor: pointer; }

        /* --- HUD & UI --- */
        #hud { position: fixed; inset: 0; pointer-events: none; z-index: 1000; }
        .pointer-all { pointer-events: all; }

        .top-nav {
            padding: 30px; display: flex; justify-content: space-between; align-items: flex-start;
        }
        .logo-box { font-family: var(--font-tech); font-weight: 900; letter-spacing: 5px; }
        .logo-box span { display: block; font-size: 10px; color: var(--neon-green); letter-spacing: 2px; }

        .stats-panel {
            position: absolute; bottom: 30px; left: 30px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .stat-card {
            background: var(--glass); border: 1px solid var(--border-glow);
            padding: 12px 20px; border-radius: 8px; font-size: 12px;
            display: flex; align-items: center; gap: 15px; backdrop-filter: blur(10px);
        }
        .stat-icon { color: var(--neon-green); font-size: 18px; }

        /* --- SPAM PROTECTOR (TIMER) --- */
        #cooldown-bar {
            position: absolute; bottom: 0; left: 0; height: 3px;
            background: var(--neon-green); width: 0%; transition: width 0.1s linear;
        }

        /* --- ADMIN DASHBOARD (RIGHT PANEL) --- */
        #admin-panel {
            position: absolute; right: -450px; top: 0; width: 400px; height: 100vh;
            background: rgba(5, 5, 5, 0.98); border-left: 1px solid var(--neon-green);
            padding: 40px 30px; transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            overflow-y: auto;
        }
        body.admin-open #admin-panel { right: 0; }
        
        .dash-title { font-family: var(--font-tech); margin-bottom: 30px; font-size: 18px; color: var(--neon-green); border-bottom: 1px solid #222; padding-bottom: 10px; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .data-card { background: #111; padding: 15px; border-radius: 8px; border: 1px solid #222; }
        .data-card b { display: block; font-size: 24px; color: #fff; }
        .data-card small { font-size: 10px; color: #666; text-transform: uppercase; }

        .player-list-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #0a0a0a; padding: 10px; border-radius: 6px; margin-bottom: 5px; font-size: 12px;
        }
        .tp-btn { background: var(--neon-blue); color: black; border: none; padding: 4px 8px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* --- MODALS --- */
        #modal-container {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: none; align-items: center; justify-content: center; z-index: 5000;
        }
        .modal-box {
            background: #111; border: 1px solid var(--neon-green);
            width: 450px; padding: 40px; border-radius: 20px;
            box-shadow: 0 0 100px rgba(0, 255, 136, 0.1);
        }
        input, textarea {
            width: 100%; background: #000; border: 1px solid #333; color: white;
            padding: 15px; margin-bottom: 15px; border-radius: 10px; font-family: var(--font-main);
        }
        input:focus { border-color: var(--neon-green); }
        .btn-prime {
            width: 100%; padding: 15px; background: var(--neon-green); color: black;
            border: none; border-radius: 10px; font-weight: 900; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px;
        }

        /* --- CONTEXT MENU --- */
        #ctx {
            position: fixed; background: #111; border: 1px solid #333;
            padding: 8px; border-radius: 12px; display: none; width: 200px;
            z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .ctx-opt {
            padding: 12px 15px; cursor: pointer; font-size: 13px;
            display: flex; align-items: center; gap: 10px; border-radius: 8px;
        }
        .ctx-opt:hover { background: var(--neon-green); color: black; }
    </style>
</head>
<body>

    <div id="world">
        <div id="camera">
            <div class="grid-plane"></div>
            <div id="entities-mount"></div>
            <div id="phantoms-mount"></div>
        </div>
    </div>

    <div id="hud">
        <div class="top-nav">
            <div class="logo-box">META-ENGINE <span>PRO CONSOLE V5</span></div>
            <button class="pointer-all tp-btn" style="padding: 10px 20px; display:none" id="btn-back-home" onclick="Engine.loadRoom('main')">ANA MERKEZ</button>
        </div>

        <div class="stats-panel">
            <div class="stat-card">
                <i class="fa-solid fa-users stat-icon"></i>
                <div><b id="val-online">1</b> <small>AKTİF KULLANICI</small></div>
            </div>
            <div class="stat-card">
                <i class="fa-solid fa- fingerprints stat-icon"></i>
                <div><b id="val-coords">0, 0</b> <small>KOORDİNAT</small></div>
            </div>
            <div class="stat-card" style="padding:0; overflow:hidden; width: 100px;">
                <div id="cooldown-bar"></div>
                <div style="padding: 12px; font-size: 10px; text-align: center; width: 100%;">GÜVENLİ MOD</div>
            </div>
        </div>

        <div class="pointer-all" id="admin-trigger" style="position:absolute; bottom:30px; right:30px; font-size:30px; cursor:pointer; color:#333" onclick="Admin.open()">
            <i class="fa-solid fa-shield-halved"></i>
        </div>
    </div>

    <div id="admin-panel" class="pointer-all">
        <div class="dash-title">YÖNETİCİ KONTROL MERKEZİ</div>
        
        <div class="data-grid">
            <div class="data-card"><b id="adm-total-obj">0</b><small>Toplam Obje</small></div>
            <div class="data-card"><b id="adm-total-rep" style="color:var(--neon-red)">0</b><small>Raporlanan</small></div>
        </div>

        <div class="dash-title" style="font-size:12px">AKTİF KULLANICILAR VE TAKİP</div>
        <div id="adm-player-list" style="margin-bottom:30px"></div>

        <div class="dash-title" style="font-size:12px">RAPOR AKIŞI</div>
        <div id="adm-report-list"></div>

        <button class="btn-prime" style="background:#222; color:#888; margin-top:50px" onclick="Admin.logout()">SİSTEMDEN ÇIK</button>
    </div>

    <div id="modal-container" class="pointer-all">
        <div class="modal-box" id="modal-inner"></div>
    </div>

    <div id="ctx" class="pointer-all">
        <div class="ctx-opt" onclick="UI.showCreate('note')"><i class="fa-solid fa-pen-nib"></i> Not Bırak</div>
        <div class="ctx-opt" onclick="UI.showCreate('library')"><i class="fa-solid fa-box-archive"></i> Kütüphane Kur</div>
    </div>

<script>
/**
 * HASAN PRO ENGINE v5 - CORE LOGIC
 */

const CFG = {
    URL: "https://ssfgvjudifodfhovhpzx.supabase.co",
    KEY: "sb_publishable_hBGvHNaGoHd_5cLAKVUhqA_N87pXWQo",
    ADMIN_PASS: "Hasan024",
    COOLDOWN: 30000 // 30 Saniye
};

const DB = supabase.createClient(CFG.URL, CFG.KEY);

const State = {
    room: 'main',
    cam: { x: window.innerWidth/2, y: window.innerHeight/2, z: 1 },
    drag: { is: false, lx: 0, ly: 0 },
    mouse: { x: 0, y: 0 },
    lastAction: 0,
    isAdmin: localStorage.getItem('isAdm') === 'true',
    myId: 'user_' + Math.floor(Math.random()*9999)
};

const Engine = {
    init: async function() {
        this.bindInput();
        this.setupRealtime();
        await this.loadRoom('main');
        this.render();
        if(State.isAdmin) {
            document.body.classList.add('is-admin');
            Admin.refresh();
        }
    },

    setupRealtime: function() {
        const channel = DB.channel('meta_live', { config: { presence: { key: State.myId } } });

        channel
        .on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, payload => {
            this.handleDataChange(payload);
        })
        .on('presence', { event: 'sync' }, () => {
            this.updatePresence(channel.presenceState());
        })
        .on('presence', { event: 'join' }, ({ key, newPresences }) => {
            UI.toast("Bir gezgin evrene girdi", "info");
        })
        .subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
                await channel.track({ 
                    x: State.mouse.x, 
                    y: State.mouse.y, 
                    room: State.room,
                    online_at: new Date().toISOString() 
                });
            }
        });

        this.liveChannel = channel;
    },

    updatePresence: function(presences) {
        const mount = document.getElementById('phantoms-mount');
        const admList = document.getElementById('adm-player-list');
        mount.innerHTML = '';
        admList.innerHTML = '';
        
        let count = 0;
        for (const id in presences) {
            count++;
            const p = presences[id][0];
            if(id === State.myId) continue;

            // Haritadaki Phantomlar
            if(p.room === State.room) {
                const dot = document.createElement('div');
                dot.className = 'phantom';
                dot.style.left = p.x + 'px';
                dot.style.top = p.y + 'px';
                dot.innerHTML = `<div class="phantom-label">${id}</div>`;
                mount.appendChild(dot);
            }

            // Admin Listesi
            if(State.isAdmin) {
                const item = document.createElement('div');
                item.className = 'player-list-item';
                item.innerHTML = `
                    <span>${id} (${p.room})</span>
                    <button class="tp-btn" onclick="Admin.tpTo(${p.x}, ${p.y}, '${p.room}')">İZLE</button>
                `;
                admList.appendChild(item);
            }
        }
        document.getElementById('val-online').innerText = count;
    },

    handleDataChange: function(payload) {
        const { eventType, new: newItem, old: oldItem } = payload;
        if(State.isAdmin) Admin.refresh();

        if(eventType === 'INSERT' && newItem.room_id === State.room) this.drawItem(newItem);
        if(eventType === 'DELETE') document.getElementById('ent-' + oldItem.id)?.remove();
        if(eventType === 'UPDATE') {
            document.getElementById('ent-' + newItem.id)?.remove();
            if(newItem.room_id === State.room) this.drawItem(newItem);
        }
    },

    loadRoom: async function(rid) {
        State.room = rid;
        document.getElementById('btn-back-home').style.display = rid === 'main' ? 'none' : 'block';
        document.getElementById('entities-mount').innerHTML = '';
        
        const { data } = await DB.from('items').select('*').eq('room_id', rid);
        if(data) data.forEach(d => this.drawItem(d));
        
        // Odayı presence üzerinde güncelle
        this.liveChannel.track({ x: State.mouse.x, y: State.mouse.y, room: rid });
        
        // Kamerayı Merkeze Al
        State.cam.x = window.innerWidth/2;
        State.cam.y = window.innerHeight/2;
        this.render();
    },

    drawItem: function(item) {
        const div = document.createElement('div');
        div.id = 'ent-' + item.id;
        div.className = `entity type-${item.type} ${item.is_reported ? 'is-reported' : ''}`;
        div.style.left = item.x + 'px';
        div.style.top = item.y + 'px';

        const adminControls = State.isAdmin ? `<i class="fa-solid fa-trash-can" style="color:var(--neon-red); cursor:pointer" onclick="Admin.deleteItem(${item.id})"></i>` : '';

        div.innerHTML = `
            <h3>${item.title} <div>${adminControls} <i class="fa-solid fa-flag" style="margin-left:10px; cursor:pointer" onclick="Engine.report(${item.id})"></i></div></h3>
            <p>${item.content}</p>
        `;

        if(item.type === 'library') div.onclick = () => this.loadRoom(item.title);
        document.getElementById('entities-mount').appendChild(div);
    },

    report: async function(id) {
        UI.toast("Rapor iletiliyor...", "info");
        await DB.from('items').update({ is_reported: true }).eq('id', id);
        UI.toast("Başarıyla raporlandı", "success");
    },

    bindInput: function() {
        const v = document.getElementById('world');
        v.onmousedown = e => {
            if(e.button === 0) { State.drag.is = true; State.drag.lx = e.clientX; State.drag.ly = e.clientY; }
        };
        window.onmouseup = () => State.drag.is = false;
        window.onmousemove = e => {
            if(State.drag.is) {
                State.cam.x += e.clientX - State.drag.lx;
                State.cam.y += e.clientY - State.drag.ly;
                State.drag.lx = e.clientX; State.drag.ly = e.clientY;
                this.render();
            }
            // Dünya koordinat hesabı
            const wx = Math.round((e.clientX - State.cam.x) / State.cam.z);
            const wy = Math.round((e.clientY - State.cam.y) / State.cam.z);
            document.getElementById('val-coords').innerText = `${wx}, ${wy}`;
            State.mouse = { x: wx, y: wy };
            
            // Presence güncelle (Throttled)
            if(Date.now() % 10 === 0) this.liveChannel.track({ x: wx, y: wy, room: State.room });
        };
        v.onwheel = e => {
            const s = e.deltaY > 0 ? 0.9 : 1.1;
            State.cam.z = Math.min(Math.max(0.1, State.cam.z * s), 5);
            this.render();
        };
        v.oncontextmenu = e => {
            e.preventDefault();
            const m = document.getElementById('ctx');
            m.style.display = 'block'; m.style.left = e.clientX+'px'; m.style.top = e.clientY+'px';
        };
        window.onclick = () => document.getElementById('ctx').style.display='none';
    },

    render: function() {
        document.getElementById('camera').style.transform = `translate(${State.cam.x}px, ${State.cam.y}px) scale(${State.cam.z})`;
    }
};

const UI = {
    toast: function(msg, type) {
        const color = type === 'success' ? var(--neon-green) : (type === 'error' ? 'red' : var(--neon-blue));
        // Basit toast yerine konsola da yazabiliriz ama profesyonel olsun:
        console.log(`[${type}] ${msg}`);
        // Not: Burada daha önce yazdığımız toast kodlarını kullanabilirsin, yer darlığından özet geçtim.
    },

    showCreate: function(type) {
        const now = Date.now();
        if(now - State.lastAction < CFG.COOLDOWN) {
            const remain = Math.ceil((CFG.COOLDOWN - (now - State.lastAction)) / 1000);
            return alert(`Spam koruması aktif! ${remain} saniye bekle.`);
        }

        const modal = document.getElementById('modal-container');
        const inner = document.getElementById('modal-inner');
        inner.innerHTML = `
            <h2 style="color:var(--neon-green); font-family:var(--font-tech); margin-bottom:20px">${type === 'note' ? 'NOT BIRAK' : 'KÜTÜPHANE KUR'}</h2>
            <input id="f-title" placeholder="Başlık...">
            <textarea id="f-content" rows="5" placeholder="İçerik mesajınız..."></textarea>
            <button class="btn-prime" onclick="UI.submit('${type}')">DÜNYAYA YAYINLA</button>
            <button class="btn-prime" style="background:transparent; color:#555" onclick="UI.closeModal()">İPTAL</button>
        `;
        modal.style.display = 'flex';
    },

    submit: async function(type) {
        const t = document.getElementById('f-title').value;
        const c = document.getElementById('f-content').value;
        if(!t || !c) return;

        const { error } = await DB.from('items').insert([{
            title: t, content: c, type: type, x: State.mouse.x, y: State.mouse.y, room_id: State.room
        }]);

        if(!error) {
            State.lastAction = Date.now();
            this.startCooldown();
            this.closeModal();
        }
    },

    startCooldown: function() {
        const bar = document.getElementById('cooldown-bar');
        bar.style.width = '100%';
        bar.style.transition = 'none';
        setTimeout(() => {
            bar.style.transition = `width ${CFG.COOLDOWN}ms linear`;
            bar.style.width = '0%';
        }, 50);
    },

    closeModal: function() { document.getElementById('modal-container').style.display = 'none'; }
};

const Admin = {
    open: function() {
        if(!State.isAdmin) {
            const p = prompt("Yönetici Kodunu Girin:");
            if(p === CFG.ADMIN_PASS) {
                localStorage.setItem('isAdm', 'true');
                location.reload();
            }
        } else {
            document.body.classList.toggle('admin-open');
            this.refresh();
        }
    },

    refresh: async function() {
        const { count: total } = await DB.from('items').select('*', { count: 'exact', head: true });
        const { data: reports, count: repCount } = await DB.from('items').select('*', { count: 'exact' }).eq('is_reported', true);
        
        document.getElementById('adm-total-obj').innerText = total || 0;
        document.getElementById('adm-total-rep').innerText = repCount || 0;

        const list = document.getElementById('adm-report-list');
        list.innerHTML = '';
        reports?.forEach(r => {
            const d = document.createElement('div');
            d.className = 'player-list-item';
            d.innerHTML = `<span>${r.title}</span> 
                <div>
                    <button class="tp-btn" style="background:var(--neon-red)" onclick="Admin.deleteItem(${r.id})">SİL</button>
                    <button class="tp-btn" onclick="Admin.tpTo(${r.x}, ${r.y}, '${r.room_id}')">GİT</button>
                </div>`;
            list.appendChild(d);
        });
    },

    tpTo: function(x, y, rid) {
        if(State.room !== rid) Engine.loadRoom(rid);
        State.cam.x = (window.innerWidth/2) - x;
        State.cam.y = (window.innerHeight/2) - y;
        Engine.render();
    },

    deleteItem: async function(id) {
        await DB.from('items').delete().eq('id', id);
        this.refresh();
    },

    logout: function() { localStorage.removeItem('isAdm'); location.reload(); }
};

Engine.init();

</script>
</body>
</html>
