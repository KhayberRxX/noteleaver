<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave a Note | Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root { --p: #00ff88; --bg: #050505; --s: #111; --danger: #ff3e3e; }
        * { box-sizing: border-box; outline: none; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; }

        /* --- GAME ENGINE MAP --- */
        #world { width: 100vw; height: 100vh; position: relative; overflow: hidden; cursor: grab; background: #000; }
        #canvas-wrap { position: absolute; width: 60000px; height: 60000px; transform-origin: 0 0; will-change: transform; background-image: radial-gradient(#222 1px, transparent 1px); background-size: 50px 50px; }

        /* --- SIDEBAR NAV --- */
        #sidebar { position: fixed; left: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 15px; }
        .nav-btn { width: 60px; height: 60px; background: var(--s); border: 1px solid #333; border-radius: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .nav-btn:hover { border-color: var(--p); transform: scale(1.1); color: var(--p); }
        .nav-btn.active { background: var(--p); color: #000; }

        /* --- BAN SCREEN --- */
        #ban-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; backdrop-filter: blur(10px); }
        #ban-overlay h1 { color: var(--danger); font-size: 64px; margin: 0; }

        /* --- MODERN WINDOWS --- */
        .window { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 450px; background: var(--s); border: 1px solid #333; border-radius: 25px; padding: 30px; z-index: 2000; display: none; box-shadow: 0 30px 60px rgba(0,0,0,0.8); }
        .window.active { display: block; animation: flowIn 0.4s ease; }
        @keyframes flowIn { from { opacity: 0; transform: translate(-50%, -45%); } to { opacity: 1; transform: translate(-50%, -50%); } }

        /* --- ELEMENTS --- */
        input, textarea { width: 100%; background: #000; border: 1px solid #222; color: #fff; padding: 15px; border-radius: 12px; margin-top: 10px; font-size: 16px; }
        .submit-btn { width: 100%; padding: 15px; background: var(--p); border: none; border-radius: 12px; font-weight: bold; margin-top: 20px; cursor: pointer; color: #000; }
        
        .note-obj { position: absolute; padding: 20px; background: rgba(20,20,20,0.9); border: 1px solid #333; border-radius: 15px; backdrop-filter: blur(5px); min-width: 200px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .note-obj:hover { border-color: var(--p); z-index: 500; }
        .note-obj h3 { margin: 0 0 10px 0; color: var(--p); border-bottom: 1px solid #222; }

        #hud { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 30px; font-family: monospace; font-size: 12px; color: #666; pointer-events: none; }
    </style>
</head>
<body>

<div id="ban-overlay">
    <h1>ERI≈ûIM ENGELLENDI</h1>
    <p id="ban-text">Kural ihlali nedeniyle uzakla≈ütƒ±rƒ±ldƒ±nƒ±z.</p>
    <div id="ban-timer" style="font-size: 24px; color: var(--p)">00:00</div>
</div>

<div id="sidebar">
    <div class="nav-btn" onclick="openWin('note-win')" title="Not Bƒ±rak">üìù</div>
    <div class="nav-btn" onclick="openWin('draw-win')" title="√áizim Yap">üé®</div>
    <div class="nav-btn" onclick="openWin('lib-win')" title="K√ºt√ºphane">üìö</div>
    <div class="nav-btn" onclick="openWin('admin-win')" title="Y√∂netim">‚öôÔ∏è</div>
</div>

<div id="world">
    <div id="canvas-wrap"></div>
</div>

<div id="hud">
    COORD: <span id="cx">0</span>, <span id="cy">0</span> | ZOOM: <span id="cz">1.0</span>
</div>

<div id="note-win" class="window">
    <h2>üìù Yeni Not</h2>
    <input type="text" id="n-title" placeholder="Ba≈ülƒ±k...">
    <textarea id="n-body" rows="4" placeholder="Mesajƒ±nƒ±z..."></textarea>
    <button class="submit-btn" onclick="save('note')">D√úNYAYA EKLE</button>
    <button onclick="closeWins()" style="width:100%; background:none; border:none; color:#555; margin-top:10px; cursor:pointer">Kapat</button>
</div>

<div id="admin-win" class="window">
    <h2>‚öôÔ∏è Y√∂netici Giri≈üi</h2>
    <input type="password" id="admin-pass" placeholder="≈ûifre...">
    <button class="submit-btn" onclick="adminAuth()">GIRI≈û YAP</button>
    <div id="admin-controls" style="display:none; margin-top:20px">
        <h3 style="color:var(--danger)">üö© Raporlar</h3>
        <div id="report-list" style="max-height:200px; overflow-y:auto"></div>
    </div>
</div>

<script>
    const S_URL = "https://ssfgvjudifodfhovhpzx.supabase.co";
    const S_KEY = "sb_publishable_hBGvHNaGoHd_5cLAKVUhqA_N87pXWQo";
    const _db = supabase.createClient(S_URL, S_KEY);

    let scale = 1, offsetX = -30000, offsetY = -30000;
    let isDragging = false, lastX, lastY, isAdmin = false;
    const wrap = document.getElementById('canvas-wrap');
    const world = document.getElementById('world');

    // --- ENGINE: MOVEMENT & ZOOM ---
    world.addEventListener('wheel', e => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        scale = Math.min(Math.max(0.1, scale * delta), 3);
        updateTransform();
    }, {passive: false});

    world.addEventListener('mousedown', e => { if(e.target === world || e.target === wrap) { isDragging = true; lastX = e.clientX; lastY = e.clientY; }});
    window.addEventListener('mousemove', e => {
        const rect = wrap.getBoundingClientRect();
        document.getElementById('cx').innerText = Math.round((e.clientX - rect.left) / scale);
        document.getElementById('cy').innerText = Math.round((e.clientY - rect.top) / scale);
        
        if(!isDragging) return;
        offsetX += (e.clientX - lastX);
        offsetY += (e.clientY - lastY);
        lastX = e.clientX; lastY = e.clientY;
        updateTransform();
    });
    window.addEventListener('mouseup', () => isDragging = false);

    function updateTransform() {
        wrap.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
        document.getElementById('cz').innerText = scale.toFixed(1);
    }

    // --- UI LOGIC ---
    function openWin(id) { closeWins(); document.getElementById(id).classList.add('active'); }
    function closeWins() { document.querySelectorAll('.window').forEach(w => w.classList.remove('active')); }

    // --- DATA ---
    async function save(type) {
        const title = document.getElementById('n-title').value;
        const content = document.getElementById('n-body').value;
        const rect = wrap.getBoundingClientRect();
        // Merkeze not bƒ±rakma mantƒ±ƒüƒ±
        const x = (window.innerWidth/2 - offsetX) / scale;
        const y = (window.innerHeight/2 - offsetY) / scale;

        const { error } = await _db.from('items').insert([{ title, content, x, y, type, user_id: 'HasanUser' }]);
        if(!error) location.reload();
    }

    async function load() {
        const { data } = await _db.from('items').select('*');
        data?.forEach(item => {
            const div = document.createElement('div');
            div.className = 'note-obj';
            div.style.left = item.x + 'px';
            div.style.top = item.y + 'px';
            div.innerHTML = `<h3>${item.title}</h3><p>${item.content}</p>
                <button onclick="report(${item.id})" style="font-size:10px; background:none; border:1px solid #444; color:#666; cursor:pointer">Raporla</button>
                <button class="adm-btn" onclick="adminDel(${item.id}, '${item.user_id}')" style="display:none; color:red">Sƒ∞L & BAN</button>`;
            wrap.appendChild(div);
        });
        updateTransform();
        checkBan();
    }

    async function checkBan() {
        const { data } = await _db.from('site_users').select('*').eq('user_id', 'HasanUser').single();
        if(data && new Date(data.banned_until) > new Date()) {
            document.getElementById('ban-overlay').style.display = 'flex';
            // Saya√ß eklenebilir
        }
    }

    function adminAuth() {
        if(document.getElementById('admin-pass').value === "Hasan0245") {
            isAdmin = true;
            document.getElementById('admin-controls').style.display = 'block';
            document.querySelectorAll('.adm-btn').forEach(b => b.style.display = 'block');
            alert("Yetki onaylandƒ±.");
        }
    }

    window.onload = load;
</script>
</body>
</html>
