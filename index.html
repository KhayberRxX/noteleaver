<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Leave a Note | Pro Meta-Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;800&family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --p: #00ff88; --p-glow: rgba(0, 255, 136, 0.3);
            --bg: #000000; --ui: rgba(10, 10, 10, 0.9);
            --border: rgba(255, 255, 255, 0.08);
            --lib-color: #00d4ff; --book-color: #ffcc00;
        }

        * { box-sizing: border-box; outline: none; -webkit-font-smoothing: antialiased; }
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: var(--bg); color: white; font-family: 'Inter', sans-serif; cursor: crosshair; }

        /* --- LOADING & TRANSITION --- */
        #portal-fx {
            position: fixed; inset: 0; background: #000; z-index: 100000;
            display: none; align-items: center; justify-content: center;
            font-family: 'JetBrains Mono'; font-size: 24px; color: var(--p);
        }

        /* --- CAMERA & STAGE --- */
        #viewport { width: 100vw; height: 100vh; position: relative; overflow: hidden; background: radial-gradient(circle at center, #0a0a0a 0%, #000 100%); }
        #camera {
            position: absolute; width: 200000px; height: 200000px;
            background-image: radial-gradient(var(--border) 1px, transparent 1px);
            background-size: 100px 100px; transform-origin: 0 0; will-change: transform;
        }

        /* --- TOP NAVIGATION BAR --- */
        #nav-bar {
            position: fixed; top: 0; left: 0; width: 100%; padding: 20px 40px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            display: flex; justify-content: space-between; align-items: center; z-index: 5000;
            border-bottom: 1px solid var(--border); backdrop-filter: blur(10px);
        }
        #room-info { font-family: 'JetBrains Mono'; font-weight: 800; font-size: 20px; color: var(--p); text-transform: uppercase; letter-spacing: 2px; }
        .back-btn { padding: 10px 20px; background: var(--p); color: #000; border-radius: 8px; font-weight: 900; cursor: pointer; text-decoration: none; font-size: 12px; }

        /* --- ENTITIES (NOT, K√úT√úPHANE, Kƒ∞TAP) --- */
        .entity {
            position: absolute; padding: 25px; background: var(--ui);
            border: 1px solid var(--border); border-radius: 20px;
            min-width: 280px; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: all; box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        .entity:hover { border-color: var(--p); transform: scale(1.05) translateY(-5px); box-shadow: 0 0 30px var(--p-glow); }
        .entity h3 { margin: 0 0 10px 0; font-weight: 900; font-size: 20px; letter-spacing: -0.5px; }
        .entity p { margin: 0; color: #aaa; font-size: 14px; line-height: 1.6; }

        .type-library { border-left: 5px solid var(--lib-color); cursor: pointer; }
        .type-library h3 { color: var(--lib-color); }
        .type-book { border-left: 5px solid var(--book-color); background: #1a1500; }
        .type-book h3 { color: var(--book-color); }

        /* --- CONTEXT MENU --- */
        #ctx {
            position: fixed; display: none; background: #0a0a0a; border: 1px solid var(--p);
            border-radius: 12px; padding: 8px; z-index: 10000; width: 220px; box-shadow: 0 10px 30px rgba(0,0,0,1);
        }
        .ctx-item { padding: 12px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .ctx-item:hover { background: var(--p); color: #000; }

        /* --- MODAL --- */
        #modal-ovl {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 20000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal { background: #050505; border: 1px solid var(--p); padding: 40px; border-radius: 30px; width: 450px; }
        input, textarea { width: 100%; background: #111; border: 1px solid #333; color: white; padding: 18px; margin-bottom: 20px; border-radius: 12px; font-size: 16px; }
        .save-btn { width: 100%; padding: 18px; background: var(--p); border: none; border-radius: 12px; font-weight: 900; cursor: pointer; font-size: 16px; }

        /* --- HUD --- */
        #hud { position: fixed; bottom: 20px; left: 20px; display: flex; gap: 10px; z-index: 1000; }
        .chip { background: var(--ui); padding: 10px 20px; border-radius: 50px; border: 1px solid var(--border); font-size: 11px; font-family: 'JetBrains Mono'; color: #666; }
        .chip span { color: var(--p); }
    </style>
</head>
<body>

<div id="portal-fx">PORTAL AKTƒ∞F EDƒ∞Lƒ∞YOR...</div>

<div id="nav-bar">
    <div id="room-info">ANA EVREN</div>
    <div class="back-btn" id="back-home" style="display:none" onclick="Engine.enterRoom('main')">‚Üê MERKEZE D√ñN</div>
</div>

<div id="hud">
    <div class="chip">COORD: <span id="val-xy">0, 0</span></div>
    <div class="chip">ZOOM: <span id="val-z">100%</span></div>
</div>

<div id="ctx">
    <div class="ctx-item" id="ctx-note" onclick="Engine.openModal('note')">üìù Not Bƒ±rak</div>
    <div class="ctx-item" id="ctx-lib" onclick="Engine.openModal('library')">üìö K√ºt√ºphane Kur</div>
</div>

<div id="modal-ovl">
    <div class="modal">
        <h2 id="m-title" style="margin-top:0">Veri Giri≈üi</h2>
        <input type="text" id="m-input-t" placeholder="Ba≈ülƒ±k">
        <textarea id="m-input-c" rows="5" placeholder="ƒ∞√ßeriƒüinizi buraya yazƒ±n..."></textarea>
        <button class="save-btn" onclick="Engine.save()">YAYINLA</button>
        <p onclick="Engine.closeModal()" style="text-align:center; color:#444; cursor:pointer; margin-top:15px">Vazge√ß</p>
    </div>
</div>

<div id="viewport">
    <div id="camera">
        <div style="position:absolute; left:100000px; top:100000px; transform:translate(-50%,-50%); width:300px; height:300px; border:1px solid var(--p); border-radius:50%; opacity:0.2; pointer-events:none;"></div>
    </div>
</div>

<script>
const Engine = {
    config: {
        SB_URL: "https://ssfgvjudifodfhovhpzx.supabase.co",
        SB_KEY: "sb_publishable_hBGvHNaGoHd_5cLAKVUhqA_N87pXWQo",
        CENTER: 100000
    },

    state: {
        db: null,
        x: 0, y: 0, scale: 1,
        isDrag: false, lastM: {x:0, y:0},
        targetCoord: {x:0, y:0},
        room: 'main',
        mType: 'note'
    },

    init: async function() {
        this.state.db = supabase.createClient(this.config.SB_URL, this.config.SB_KEY);
        this.bind();
        this.spawn();
        await this.load();
    },

    bind: function() {
        const cam = document.getElementById('camera');

        window.onmousedown = (e) => {
            if(e.button === 0 && (e.target.id === 'viewport' || e.target.id === 'camera')) {
                this.state.isDrag = true;
                this.state.lastM = {x: e.clientX, y: e.clientY};
                cam.style.transition = "none";
            }
        };
        window.onmouseup = () => this.state.isDrag = false;

        window.onmousemove = (e) => {
            if(this.state.isDrag) {
                this.state.x += (e.clientX - this.state.lastM.x);
                this.state.y += (e.clientY - this.state.lastM.y);
                this.state.lastM = {x: e.clientX, y: e.clientY};
                this.update();
            }
            const rect = cam.getBoundingClientRect();
            const wx = Math.round((e.clientX - rect.left) / this.state.scale);
            const wy = Math.round((e.clientY - rect.top) / this.state.scale);
            document.getElementById('val-xy').innerText = `${wx}, ${wy}`;
        };

        window.onwheel = (e) => {
            e.preventDefault();
            const zSpeed = 0.04;
            const delta = e.deltaY > 0 ? -zSpeed : zSpeed;
            const oldS = this.state.scale;
            const newS = Math.min(Math.max(0.1, oldS + delta), 2);

            const cx = window.innerWidth / 2;
            const cy = window.innerHeight / 2;

            this.state.x = cx - (cx - this.state.x) * (newS / oldS);
            this.state.y = cy - (cy - this.state.y) * (newS / oldS);
            this.state.scale = newS;
            cam.style.transition = "none";
            this.update();
        };

        window.oncontextmenu = (e) => {
            e.preventDefault();
            const rect = cam.getBoundingClientRect();
            this.state.targetCoord = {
                x: Math.round((e.clientX - rect.left) / this.state.scale),
                y: Math.round((e.clientY - rect.top) / this.state.scale)
            };
            const m = document.getElementById('ctx');
            m.style.display = 'block'; m.style.left = e.clientX + 'px'; m.style.top = e.clientY + 'px';
        };

        window.onclick = () => document.getElementById('ctx').style.display = 'none';
    },

    update: function() {
        document.getElementById('camera').style.transform = `translate(${this.state.x}px, ${this.state.y}px) scale(${this.state.scale})`;
        document.getElementById('val-z').innerText = Math.round(this.state.scale * 100) + "%";
    },

    spawn: function() {
        this.state.scale = 0.8;
        this.state.x = -(this.config.CENTER * 0.8) + (window.innerWidth / 2);
        this.state.y = -(this.config.CENTER * 0.8) + (window.innerHeight / 2);
        document.getElementById('camera').style.transition = "transform 1s cubic-bezier(0.19, 1, 0.22, 1)";
        this.update();
    },

    openModal: function(type) {
        this.state.mType = type;
        document.getElementById('m-title').innerText = type === 'library' ? 'Yeni K√ºt√ºphane' : 'Yeni Not';
        document.getElementById('modal-ovl').style.display = 'flex';
    },

    closeModal: function() { document.getElementById('modal-ovl').style.display = 'none'; },

    save: async function() {
        const t = document.getElementById('m-input-t').value;
        const c = document.getElementById('m-input-c').value;
        if(!t || !c) return;

        const item = {
            title: t, content: c, x: this.state.targetCoord.x, y: this.state.targetCoord.y,
            type: this.state.mType, room_id: this.state.room
        };

        const { error } = await this.state.db.from('items').insert([item]);
        if(error) alert("Hata: " + error.message);
        else {
            this.closeModal();
            location.reload();
        }
    },

    load: async function() {
        const { data } = await this.state.db.from('items').select('*').eq('room_id', this.state.room);
        data?.forEach(item => {
            const el = document.createElement('div');
            el.className = `entity type-${item.type}`;
            el.style.left = item.x + 'px'; el.style.top = item.y + 'px';
            el.innerHTML = `<h3>${item.title}</h3><p>${item.content}</p>`;
            
            if(item.type === 'library') {
                el.onclick = () => this.enterRoom(item.title);
            }
            document.getElementById('camera').appendChild(el);
        });
    },

    enterRoom: function(roomName) {
        const fx = document.getElementById('portal-fx');
        fx.style.display = 'flex';
        setTimeout(async () => {
            this.state.room = roomName;
            this.state.x = 0; this.state.y = 0; // Oda i√ßi reset
            document.getElementById('camera').innerHTML = ''; 
            document.getElementById('room-info').innerText = roomName;
            document.getElementById('back-home').style.display = roomName === 'main' ? 'none' : 'block';
            
            // Eƒüer yeni odaya girildiyse odaya √∂zel spawn
            if(roomName !== 'main') {
                this.state.x = (window.innerWidth / 2) - 100000;
                this.state.y = (window.innerHeight / 2) - 100000;
            } else {
                this.spawn();
            }

            await this.load();
            this.update();
            fx.style.display = 'none';
        }, 800);
    }
};

Engine.init();
</script>
</body>
</html>
