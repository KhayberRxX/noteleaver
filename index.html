<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave a Note</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%2300ff88%22/><text y=%22.9em%22 font-size=%2260%22 x=%225%22 font-family=%22sans-serif%22 font-weight=%22bold%22 fill=%22black%22>LN</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root { --bg: #0b0b0b; --panel: #1a1a1a; --accent: #00ff88; --text: #e0e0e0; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; overflow: hidden; user-select: none; }
        
        /* Harita ve S√ºr√ºkleme */
        #viewport { width: 100vw; height: 100vh; overflow: hidden; position: relative; cursor: grab; }
        #viewport:active { cursor: grabbing; }
        #map { width: 20000px; height: 20000px; position: absolute; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 60px 60px; transform: translate(-10000px, -10000px); }
        
        /* Notlar */
        .item { position: absolute; padding: 15px; background: rgba(30,30,30,0.9); border: 1px solid #444; border-radius: 10px; min-width: 150px; pointer-events: all; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .item h4 { margin: 0 0 8px 0; color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 5px; }
        .item.library { width: 250px; border: 2px solid var(--accent); }
        .delete-btn { display: none; background: red; color: white; border: none; padding: 5px; cursor: pointer; border-radius: 5px; margin-top: 10px; width: 100%; }

        /* Aray√ºz */
        #ui { position: fixed; top: 20px; left: 20px; z-index: 2000; display: flex; gap: 10px; pointer-events: none; }
        .ui-box { background: rgba(20,20,20,0.9); padding: 10px 20px; border-radius: 30px; border: 1px solid #444; pointer-events: all; }
        #coords { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; font-size: 12px; color: var(--accent); }

        /* Modallar */
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); padding: 30px; border-radius: 20px; z-index: 3000; border: 1px solid var(--accent); width: 350px; display: none; }
        input, textarea { width: 100%; background: #000; color: white; border: 1px solid #444; padding: 12px; margin: 10px 0; border-radius: 8px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 12px; background: var(--accent); border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: black; }
        
        #menu { position: absolute; background: var(--panel); border: 1px solid #444; border-radius: 10px; display: none; flex-direction: column; padding: 5px; z-index: 1000; }
        #menu button { background: none; border: none; color: white; padding: 12px 25px; text-align: left; cursor: pointer; }
        #menu button:hover { background: var(--accent); color: black; border-radius: 5px; }
    </style>
</head>
<body>

<div id="ui">
    <div class="ui-box">ID: <span id="my-id" style="color:var(--accent)">...</span></div>
    <div class="ui-box">Kalan Hak: <span id="lib-count">3</span></div>
    <div class="ui-box" style="cursor:pointer" onclick="askAdmin()">‚öôÔ∏è</div>
</div>

<div id="viewport">
    <div id="map"></div>
</div>

<div id="coords">X: 0, Y: 0</div>

<div id="menu">
    <button onclick="openModal('note')">üìù Not Bƒ±rak</button>
    <button onclick="openModal('library')">üìö K√ºt√ºphane Kur</button>
</div>

<div id="modal" class="modal">
    <h3 id="modal-title">Ekle</h3>
    <input type="text" id="title-input" placeholder="Ba≈ülƒ±k...">
    <textarea id="content-input" rows="4" placeholder="Mesajƒ±nƒ±z..."></textarea>
    <button class="btn-main" onclick="saveItem()">YAYINLA</button>
    <button onclick="closeModal()" style="background:none; border:none; color:gray; width:100%; margin-top:10px; cursor:pointer">Kapat</button>
</div>

<script>
    const SUPABASE_URL = 'https://ssfgvjudifodfhovhpzx.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_hBGvHNaGoHd_5cLAKVUhqA_N87pXWQo';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let isAdmin = false;
    let isDragging = false;
    let startX, startY, scrollLeft, scrollTop;
    const viewport = document.getElementById('viewport');
    const map = document.getElementById('map');
    const menu = document.getElementById('menu');

    // 1. Harita S√ºr√ºkleme Mantƒ±ƒüƒ±
    viewport.addEventListener('mousedown', (e) => {
        if(e.target !== map) return;
        isDragging = true;
        startX = e.pageX - map.offsetLeft;
        startY = e.pageY - map.offsetTop;
    });
    window.addEventListener('mouseup', () => isDragging = false);
    window.addEventListener('mousemove', (e) => {
        if (!isDragging) {
            // Koordinat Takibi
            const rect = map.getBoundingClientRect();
            document.getElementById('coords').innerText = `X: ${Math.round(e.pageX - rect.left)}, Y: ${Math.round(e.pageY - rect.top)}`;
            return;
        }
        map.style.left = (e.pageX - startX) + 'px';
        map.style.top = (e.pageY - startY) + 'px';
    });

    // 2. Saƒü Tƒ±k Men√º
    map.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const rect = map.getBoundingClientRect();
        currentX = e.pageX - rect.left;
        currentY = e.pageY - rect.top;
        menu.style.display = 'flex';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
    });
    map.addEventListener('click', () => menu.style.display = 'none');

    // 3. Kimlik
    let userId = localStorage.getItem('userId') || "U-" + Math.floor(Math.random()*9000);
    localStorage.setItem('userId', userId);
    document.getElementById('my-id').innerText = userId;

    function openModal(type) {
        currentType = type;
        document.getElementById('modal').style.display = 'block';
        menu.style.display = 'none';
    }

    async function saveItem() {
        const title = document.getElementById('title-input').value;
        const content = document.getElementById('content-input').value;
        if(!title || !content) return;

        const { error } = await _supabase.from('items').insert([{ 
            type: currentType, title: title, content: content, x: currentX, y: currentY, user_id: userId 
        }]);

        if(!error) {
            location.reload();
        }
    }

    function renderItem(item) {
        const div = document.createElement('div');
        div.className = 'item ' + item.type;
        div.style.left = item.x + 'px';
        div.style.top = item.y + 'px';
        div.innerHTML = `
            <h4>${item.title}</h4>
            <p>${item.content}</p>
            <small style="font-size:9px; color:gray">ID: ${item.user_id}</small>
            <button class="delete-btn" id="del-${item.id}" onclick="deleteItem(${item.id})">Sƒ∞L (ADMƒ∞N)</button>
        `;
        if(isAdmin) div.querySelector('.delete-btn').style.display = 'block';
        map.appendChild(div);
    }

    async function deleteItem(id) {
        if(!isAdmin) return;
        const { error } = await _supabase.from('items').delete().eq('id', id);
        if(!error) location.reload();
    }

    function askAdmin() {
        const pass = prompt("Gizli ≈ûifre:");
        if(pass === "Hasan0245") {
            isAdmin = true;
            alert("Admin yetkileri aktif. Artƒ±k notlarƒ± silebilirsin.");
            document.querySelectorAll('.delete-btn').forEach(b => b.style.display = 'block');
        }
    }

    async function useLibrary() {
        let h = parseInt(document.getElementById('lib-count').innerText);
        if(h > 0) openModal('library');
        else alert("Hak bitti!");
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    window.onload = async () => {
        const { data } = await _supabase.from('items').select('*');
        if(data) data.forEach(renderItem);
    }
</script>
</body>
</html>
