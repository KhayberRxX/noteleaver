<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>META-ENGINE V12 | ADMIN & TRACKING PRO</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;800&family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --p: #00ff88; --bg: #030303; --card: rgba(15, 15, 15, 0.9); --border: rgba(255, 255, 255, 0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; overflow: hidden; user-select: none; }

        /* ENGINE */
        #viewport { width: 100vw; height: 100vh; position: relative; overflow: hidden; cursor: crosshair; }
        #camera { position: absolute; transform-origin: 0 0; will-change: transform; pointer-events: none; }
        #grid { position: absolute; width: 200000px; height: 200000px; left: -100000px; top: -100000px; background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 50px 50px; }

        /* ENTITIES & PLAYERS */
        .entity { position: absolute; width: 260px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; backdrop-filter: blur(10px); pointer-events: auto; }
        .library { border-left: 4px solid #00d4ff; cursor: pointer; }
        .del-btn { color: #ff4444; cursor: pointer; float: right; font-size: 12px; }

        .player-cursor { position: absolute; width: 12px; height: 12px; background: var(--p); border-radius: 50%; pointer-events: none; transition: 0.1s linear; z-index: 999; }
        .player-label { position: absolute; transform: translate(15px, -5px); font-size: 10px; font-family: 'JetBrains Mono'; color: var(--p); white-space: nowrap; }

        /* HUD */
        #hud { position: fixed; inset: 0; pointer-events: none; z-index: 1000; padding: 20px; }
        .stats { position: absolute; bottom: 20px; left: 20px; background: var(--card); border: 1px solid var(--border); padding: 10px 20px; border-radius: 10px; display: flex; gap: 20px; pointer-events: auto; font-family: 'JetBrains Mono'; font-size: 12px; }
        .btn-exit { pointer-events: auto; background: #ff4444; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }

        /* ADMIN PANEL */
        #admin-panel { position: fixed; right: -350px; top: 0; width: 320px; height: 100vh; background: #080808; border-left: 1px solid var(--border); transition: 0.4s; z-index: 2000; padding: 25px; pointer-events: auto; }
        #admin-panel.open { right: 0; }
        .user-row { background: #111; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .tp-btn { background: var(--p); color: black; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="viewport">
        <div id="camera">
            <div id="grid"></div>
            <div id="entities-layer"></div>
            <div id="players-layer"></div>
        </div>
    </div>

    <div id="hud">
        <div id="nav-tools">
            <button id="exit-room" class="btn-exit" style="display:none" onclick="Engine.loadRoom('main')">← EVRENE DÖN</button>
        </div>
        <div class="stats">
            <div>POS: <span id="val-coords">0,0</span></div>
            <div>ONLINE: <span id="val-online">1</span></div>
            <div>PING: <span id="val-ping">0</span>ms</div>
        </div>
        <div id="adm-gate" onclick="Admin.toggle()" style="position:absolute; bottom:20px; right:20px; pointer-events:auto; cursor:pointer; opacity:0.5"><i class="fa-solid fa-user-shield fa-2x"></i></div>
    </div>

    <div id="admin-panel">
        <h2 style="font-family:'JetBrains Mono'; color:var(--p); margin-bottom:20px">ADMIN_CONSOLE</h2>
        <div id="user-list"></div>
    </div>

    <script>
        const SB_URL = "https://ssfgvjudifodfhovhpzx.supabase.co";
        const SB_KEY = "sb_publishable_hBGvHNaGoHd_5cLAKVUhqA_N87pXWQo";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        const Engine = {
            room: 'main',
            cam: { x: window.innerWidth/2, y: window.innerHeight/2, z: 1 },
            mouse: { x: 0, y: 0 },
            uid: 'USR-' + Math.floor(Math.random()*9000),
            isAdmin: localStorage.getItem('isAdm') === 'true',

            async init() {
                this.bindEvents();
                await this.loadRoom('main');
                this.setupRealtime();
                this.startPingTest();
            },

            bindEvents() {
                window.onmousedown = (e) => { 
                    if(e.button === 0 && e.target.id === 'viewport') {
                        this.drag = true;
                        this.moved = false;
                        this.sx = e.clientX - this.cam.x; this.sy = e.clientY - this.cam.y;
                    }
                };
                window.onmousemove = (e) => {
                    if(this.drag) {
                        this.moved = true;
                        this.cam.x = e.clientX - this.sx; this.cam.y = e.clientY - this.sy;
                        this.render();
                    }
                    this.mouse.x = Math.round((e.clientX - this.cam.x) / this.cam.z);
                    this.mouse.y = Math.round((e.clientY - this.cam.y) / this.cam.z);
                    document.getElementById('val-coords').innerText = `${this.mouse.x},${this.mouse.y}`;
                    this.broadcastPos();
                };
                window.onmouseup = (e) => {
                    if(this.drag && !this.moved) this.openInput();
                    this.drag = false;
                };
                window.onwheel = (e) => {
                    this.cam.z = Math.min(Math.max(0.2, this.cam.z * (e.deltaY > 0 ? 0.9 : 1.1)), 3);
                    this.render();
                };
            },

            render() { document.getElementById('camera').style.transform = `translate(${this.cam.x}px, ${this.cam.y}px) scale(${this.cam.z})`; },

            async loadRoom(id) {
                this.room = id;
                document.getElementById('exit-room').style.display = id === 'main' ? 'none' : 'block';
                const { data } = await supabaseClient.from('items').select('*').eq('room_id', id);
                this.drawItems(data || []);
            },

            drawItems(items) {
                const layer = document.getElementById('entities-layer');
                layer.innerHTML = '';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = `entity ${item.type}`;
                    div.style.left = item.x + 'px'; div.style.top = item.y + 'px';
                    const del = this.isAdmin ? `<i class="fa-solid fa-trash del-btn" onclick="Admin.delete('${item.id}')"></i>` : '';
                    div.innerHTML = `<h4>${item.title} ${del}</h4><p>${item.content}</p>`;
                    if(item.type === 'library') div.onclick = () => this.loadRoom(item.title);
                    layer.appendChild(div);
                });
            },

            setupRealtime() {
                const chan = supabaseClient.channel('live', { config: { presence: { key: this.uid } } });
                chan.on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, () => this.loadRoom(this.room))
                    .on('presence', { event: 'sync' }, () => this.updatePresence(chan.presenceState()))
                    .subscribe(async (s) => { if(s === 'SUBSCRIBED') await chan.track({ x: 0, y: 0, r: this.room }); });
                this.chan = chan;
            },

            broadcastPos() { if(this.chan) this.chan.track({ x: this.mouse.x, y: this.mouse.y, r: this.room }); },

            updatePresence(state) {
                const pLayer = document.getElementById('players-layer');
                const uList = document.getElementById('user-list');
                pLayer.innerHTML = ''; uList.innerHTML = '';
                let count = 0;
                for(let id in state) {
                    count++;
                    const p = state[id][0];
                    if(id !== this.uid && p.r === this.room) {
                        pLayer.innerHTML += `<div class="player-cursor" style="left:${p.x}px; top:${p.y}px"><div class="player-label">${id}</div></div>`;
                    }
                    if(this.isAdmin) {
                        uList.innerHTML += `<div class="user-row"><span>${id} (${p.r})</span> <button class="tp-btn" onclick="Admin.tp(${p.x}, ${p.y}, '${p.r}')">TP</button></div>`;
                    }
                }
                document.getElementById('val-online').innerText = count;
            },

            startPingTest() {
                setInterval(async () => {
                    const start = Date.now();
                    await supabaseClient.from('items').select('id').limit(1);
                    document.getElementById('val-ping').innerText = Date.now() - start;
                }, 5000);
            },

            async openInput() {
                const t = prompt("Başlık:"); const c = prompt("İçerik:");
                if(!t || !c) return;
                const type = confirm("Kütüphane mi? (Evet: Kütüphane, Hayır: Not)") ? 'library' : 'note';
                await supabaseClient.from('items').insert([{ title: t, content: c, type, x: this.mouse.x, y: this.mouse.y, room_id: this.room }]);
            }
        };

        const Admin = {
            toggle() {
                if(!Engine.isAdmin) {
                    if(prompt("ADMIN_PASS:") === "Hasan024") { localStorage.setItem('isAdm', 'true'); location.reload(); }
                } else { document.getElementById('admin-panel').classList.toggle('open'); }
            },
            async delete(id) { if(confirm("Silinsin mi?")) await supabaseClient.from('items').delete().eq('id', id); },
            tp(x, y, r) {
                if(Engine.room !== r) Engine.loadRoom(r);
                setTimeout(() => { Engine.cam.x = (window.innerWidth/2) - x; Engine.cam.y = (window.innerHeight/2) - y; Engine.render(); }, 500);
            }
        };

        window.onload = () => Engine.init();
    </script>
</body>
</html>
