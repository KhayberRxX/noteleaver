<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Meta-Engine: Stable Core</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505; --ui: #111; --border: #333;
            --p: #00ff88; --danger: #ff4444;
            --font: 'Inter', sans-serif;
        }
        body { margin: 0; overflow: hidden; background: var(--bg); color: white; font-family: var(--font); user-select: none; }
        
        /* --- CAMERA & WORLD --- */
        #viewport { width: 100vw; height: 100vh; position: relative; cursor: crosshair; overflow: hidden; }
        #camera { position: absolute; transform-origin: 0 0; will-change: transform; }
        
        /* Sonsuz Izgara */
        #grid {
            position: absolute; left: -100000px; top: -100000px; width: 200000px; height: 200000px;
            background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px; pointer-events: none;
        }
        /* Ba≈ülangƒ±√ß Noktasƒ± ƒ∞≈üareti */
        #origin {
            position: absolute; left: 0; top: 0; width: 20px; height: 20px;
            border: 2px solid var(--p); border-radius: 50%; transform: translate(-50%, -50%);
            opacity: 0.5; pointer-events: none; z-index: 0;
        }
        #origin::after { content: 'SPAWN'; position: absolute; top: 20px; left: -10px; font-size: 10px; color: var(--p); font-family: 'JetBrains Mono'; }

        /* --- ENTITIES --- */
        .entity {
            position: absolute; width: 220px; padding: 15px; background: rgba(10,10,10,0.9);
            border: 1px solid var(--border); border-radius: 12px; font-size: 13px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.2s;
        }
        .entity:hover { transform: scale(1.05); border-color: #666; z-index: 100; }
        .entity h3 { margin: 0 0 8px 0; font-size: 14px; color: var(--p); display: flex; justify-content: space-between; }
        .entity p { margin: 0; color: #ccc; line-height: 1.4; white-space: pre-wrap; }
        
        .type-library { border-left: 3px solid #00d4ff; cursor: pointer; }
        .type-library h3 { color: #00d4ff; text-decoration: underline; }
        
        .is-reported { border: 1px solid var(--danger); box-shadow: 0 0 10px rgba(255, 68, 68, 0.2); }

        /* --- UI LAYER --- */
        #ui-layer { position: fixed; inset: 0; pointer-events: none; z-index: 1000; }
        .pointer-auto { pointer-events: auto; }

        #top-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; align-items: flex-start; }
        .room-title { font-family: 'JetBrains Mono'; font-weight: 800; font-size: 24px; text-transform: uppercase; }
        .back-btn { background: var(--p); color: black; padding: 8px 16px; border: none; font-weight: bold; cursor: pointer; display: none; border-radius: 4px; }

        #admin-btn { position: absolute; bottom: 20px; right: 20px; background: #111; border: 1px solid #444; color: #666; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        body.is-admin #admin-btn { border-color: var(--danger); color: var(--danger); box-shadow: 0 0 15px rgba(255,0,0,0.2); }

        /* --- ADMIN PANEL --- */
        #admin-panel {
            position: absolute; right: -320px; top: 0; width: 300px; height: 100vh;
            background: rgba(0,0,0,0.95); border-left: 1px solid var(--p);
            transition: right 0.3s; padding: 20px; overflow-y: auto; pointer-events: auto;
        }
        body.panel-open #admin-panel { right: 0; }
        .report-item { background: #1a1a1a; padding: 10px; margin-bottom: 10px; border-radius: 6px; border-left: 2px solid var(--danger); }
        .adm-btn { width: 100%; padding: 5px; margin-top: 5px; background: #333; border: none; color: white; cursor: pointer; font-size: 11px; }
        .adm-btn:hover { background: var(--danger); }

        /* --- MODALS --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; pointer-events: auto; z-index: 2000; }
        .box { background: #111; border: 1px solid #444; padding: 25px; border-radius: 12px; width: 350px; }
        input, textarea { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 10px; margin-bottom: 10px; border-radius: 6px; font-family: var(--font); }
        .btn { width: 100%; padding: 12px; background: var(--p); border: none; font-weight: bold; cursor: pointer; border-radius: 6px; }

        /* --- CONTEXT MENU --- */
        #ctx { position: absolute; background: #111; border: 1px solid #444; padding: 5px; display: none; width: 160px; z-index: 5000; border-radius: 8px; }
        .ctx-opt { padding: 10px; cursor: pointer; font-size: 13px; color: #ccc; }
        .ctx-opt:hover { background: var(--p); color: black; border-radius: 4px; }
        
        /* Admin √ñzellikleri (Sadece body.is-admin varken g√∂r√ºn√ºr) */
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: inline-block !important; }
    </style>
</head>
<body>

<div id="viewport">
    <div id="camera">
        <div id="grid"></div>
        <div id="origin"></div> <div id="entities"></div>
    </div>
</div>

<div id="ui-layer">
    <div id="top-bar">
        <div>
            <div class="room-title" id="room-name">ANA EVREN</div>
            <small style="color:#666; font-family:'JetBrains Mono'" id="coords">0, 0</small>
        </div>
        <button class="back-btn pointer-auto" id="btn-back" onclick="Game.loadRoom('main')">‚Üê GERƒ∞ D√ñN</button>
    </div>

    <div id="admin-panel">
        <h3 style="color:var(--p); margin-top:0">Y√ñNETƒ∞M</h3>
        <div id="report-list"></div>
        <button class="adm-btn" style="background:#444; margin-top:20px" onclick="Admin.logout()">√áIKI≈û YAP</button>
    </div>

    <button id="admin-btn" class="pointer-auto" onclick="Admin.toggle()">‚öôÔ∏è</button>
</div>

<div class="modal" id="modal-input">
    <div class="box">
        <h3 style="margin-top:0; color:var(--p)">Yeni Kayƒ±t</h3>
        <input id="inp-t" placeholder="Ba≈ülƒ±k">
        <textarea id="inp-c" rows="4" placeholder="ƒ∞√ßerik..."></textarea>
        <button class="btn" onclick="Game.save()">OLU≈ûTUR</button>
        <button class="btn" style="background:transparent; color:#666; margin-top:5px" onclick="UI.closeModals()">ƒ∞ptal</button>
    </div>
</div>

<div class="modal" id="modal-pass">
    <div class="box">
        <h3 style="margin-top:0">Y√∂netici Giri≈üi</h3>
        <input type="password" id="inp-pass" placeholder="≈ûifre" style="text-align:center">
        <button class="btn" onclick="Admin.login()">Gƒ∞Rƒ∞≈û</button>
        <button class="btn" style="background:transparent; color:#666; margin-top:5px" onclick="UI.closeModals()">Vazge√ß</button>
    </div>
</div>

<div id="ctx" class="pointer-auto">
    <div class="ctx-opt" onclick="UI.openInput('note')">üìù Not Ekle</div>
    <div class="ctx-opt" onclick="UI.openInput('library')">üìö K√ºt√ºphane Kur</div>
</div>

<script>
// --- AYARLAR ---
const CFG = {
    URL: "https://ssfgvjudifodfhovhpzx.supabase.co",
    KEY: "sb_publishable_hBGvHNaGoHd_5cLAKVUhqA_N87pXWQo",
    PASS: "Hasan024"
};

const DB = supabase.createClient(CFG.URL, CFG.KEY);

// --- OYUN MOTORU ---
const Game = {
    room: 'main',
    items: [],
    cam: { x: 0, y: 0, z: 1 },
    drag: { active: false, x: 0, y: 0 },
    clickPos: { x: 0, y: 0 }, // Notun bƒ±rakƒ±lacaƒüƒ± koordinat
    inputType: 'note',

    init: async function() {
        this.centerCam();
        this.bindEvents();
        
        // Admin kontrol√º
        if(localStorage.getItem('isAdmin') === 'true') document.body.classList.add('is-admin');
        
        // ƒ∞lk y√ºkleme
        await this.loadRoom('main');
        
        // Realtime Dinleme (Canlƒ±)
        DB.channel('public:items')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, payload => {
              this.handleLive(payload);
          }).subscribe();
    },

    bindEvents: function() {
        const vp = document.getElementById('viewport');
        
        vp.onmousedown = e => {
            if(e.button === 0) {
                this.drag.active = true;
                this.drag.x = e.clientX; this.drag.y = e.clientY;
            }
        };
        window.onmouseup = () => this.drag.active = false;
        
        vp.onmousemove = e => {
            if(this.drag.active) {
                this.cam.x += e.clientX - this.drag.x;
                this.cam.y += e.clientY - this.drag.y;
                this.drag.x = e.clientX; this.drag.y = e.clientY;
                this.updateCam();
            }
            // Koordinat g√∂stergesi
            const r = document.getElementById('camera').getBoundingClientRect();
            const wx = Math.round((e.clientX - r.left) / this.cam.z);
            const wy = Math.round((e.clientY - r.top) / this.cam.z);
            document.getElementById('coords').innerText = `${wx}, ${wy}`;
        };

        vp.onwheel = e => {
            e.preventDefault();
            const s = e.deltaY > 0 ? 0.9 : 1.1;
            this.cam.z = Math.min(Math.max(0.2, this.cam.z * s), 3);
            this.updateCam();
        };

        vp.oncontextmenu = e => {
            e.preventDefault();
            const r = document.getElementById('camera').getBoundingClientRect();
            // Kritik d√ºzeltme: Tƒ±klanan yerin sanal koordinatƒ±nƒ± kaydet
            this.clickPos = {
                x: Math.round((e.clientX - r.left) / this.cam.z),
                y: Math.round((e.clientY - r.top) / this.cam.z)
            };
            const m = document.getElementById('ctx');
            m.style.display = 'block'; m.style.left = e.clientX+'px'; m.style.top = e.clientY+'px';
        };
        
        window.onclick = e => {
            if(!e.target.closest('#ctx')) document.getElementById('ctx').style.display = 'none';
        };
    },

    updateCam: function() {
        document.getElementById('camera').style.transform = 
            `translate(${this.cam.x}px, ${this.cam.y}px) scale(${this.cam.z})`;
    },

    centerCam: function() {
        // Ekranƒ±n tam ortasƒ±nƒ± (0,0) noktasƒ±na hizala
        this.cam.x = window.innerWidth / 2;
        this.cam.y = window.innerHeight / 2;
        this.cam.z = 1;
        this.updateCam();
    },

    loadRoom: async function(roomId) {
        this.room = roomId;
        document.getElementById('room-name').innerText = roomId === 'main' ? 'ANA EVREN' : roomId;
        document.getElementById('btn-back').style.display = roomId === 'main' ? 'none' : 'block';
        
        // Sahneyi temizle
        document.getElementById('entities').innerHTML = '';
        this.centerCam(); // Her oda deƒüi≈üiminde merkeze spawn ol

        const { data } = await DB.from('items').select('*').eq('room_id', roomId);
        this.items = data || [];
        this.items.forEach(item => this.renderItem(item));
        
        if(document.body.classList.contains('is-admin')) Admin.fetchReports();
    },

    renderItem: function(item) {
        // Aynƒ± ID varsa tekrar ekleme
        if(document.getElementById(`i-${item.id}`)) return;

        const el = document.createElement('div');
        el.id = `i-${item.id}`;
        el.className = `entity type-${item.type} ${item.is_reported ? 'is-reported' : ''}`;
        el.style.left = item.x + 'px'; el.style.top = item.y + 'px';
        
        // HTML ƒ∞√ßeriƒüi
        let html = `<h3>${item.title} 
            <div>
                <span style="cursor:pointer" onclick="event.stopPropagation(); Game.report(${item.id})">üö©</span>
                <span class="admin-only" style="cursor:pointer; color:red; margin-left:5px" onclick="event.stopPropagation(); Admin.del(${item.id})">üóëÔ∏è</span>
            </div>
        </h3><p>${item.content}</p>`;
        
        el.innerHTML = html;
        if(item.type === 'library') {
            el.onclick = () => this.loadRoom(item.title);
        }
        
        document.getElementById('entities').appendChild(el);
    },

    save: async function() {
        const t = document.getElementById('inp-t').value;
        const c = document.getElementById('inp-c').value;
        if(!t || !c) return alert("Bo≈ü bƒ±rakma!");
        
        const { error } = await DB.from('items').insert([{
            title: t, content: c, type: this.inputType, 
            x: this.clickPos.x, y: this.clickPos.y, // Doƒüru koordinat kullanƒ±lƒ±yor
            room_id: this.room
        }]);

        if(error) alert(error.message);
        else UI.closeModals();
    },

    report: async function(id) {
        if(confirm('Raporla?')) {
            await DB.from('items').update({ is_reported: true }).eq('id', id);
            alert('Bildirildi.');
        }
    },

    handleLive: function(payload) {
        const { eventType, new: newItem, old: oldItem } = payload;
        
        if(eventType === 'DELETE') {
            const el = document.getElementById(`i-${oldItem.id}`);
            if(el) el.remove();
            if(document.body.classList.contains('is-admin')) Admin.fetchReports();
        } 
        else if(eventType === 'INSERT') {
            if(newItem.room_id === this.room) this.renderItem(newItem);
        }
        else if(eventType === 'UPDATE') {
            if(newItem.is_reported && document.body.classList.contains('is-admin')) Admin.fetchReports();
            if(newItem.room_id === this.room) {
                 // Basit g√ºncelleme: sil ve tekrar yap
                 const el = document.getElementById(`i-${newItem.id}`);
                 if(el) el.remove();
                 this.renderItem(newItem);
            }
        }
    }
};

// --- ADMIN SISTEMI ---
const Admin = {
    toggle: function() {
        if(document.body.classList.contains('is-admin')) {
            document.body.classList.toggle('panel-open');
            this.fetchReports();
        } else {
            document.getElementById('modal-pass').style.display = 'flex';
        }
    },

    login: function() {
        const p = document.getElementById('inp-pass').value;
        if(p === CFG.PASS) {
            localStorage.setItem('isAdmin', 'true');
            location.reload(); // UI g√ºncellemesi i√ßin reload
        } else {
            alert('Yanlƒ±≈ü!');
        }
    },

    logout: function() {
        localStorage.removeItem('isAdmin');
        location.reload();
    },

    fetchReports: async function() {
        const { data } = await DB.from('items').select('*').eq('is_reported', true);
        const list = document.getElementById('report-list');
        list.innerHTML = '';
        if(!data || data.length === 0) list.innerHTML = '<small>Temiz</small>';
        
        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'report-item';
            div.innerHTML = `
                <div style="font-weight:bold">${item.title}</div>
                <button class="adm-btn" onclick="Admin.del(${item.id})">Sƒ∞L</button>
                <button class="adm-btn" style="background:#444" onclick="Admin.goto('${item.room_id}', ${item.x}, ${item.y})">Gƒ∞T</button>
                <button class="adm-btn" style="background:green" onclick="Admin.clear(${item.id})">TEMƒ∞ZLE</button>
            `;
            list.appendChild(div);
        });
    },

    del: async function(id) {
        if(confirm('Sil?')) await DB.from('items').delete().eq('id', id);
    },
    
    clear: async function(id) {
        await DB.from('items').update({ is_reported: false }).eq('id', id);
        this.fetchReports();
    },
    
    goto: function(room, x, y) {
        Game.loadRoom(room);
        // Kamerayƒ± oraya odakla
        setTimeout(() => {
            Game.cam.x = (window.innerWidth/2) - x;
            Game.cam.y = (window.innerHeight/2) - y;
            Game.updateCam();
        }, 100);
    }
};

// --- UI YARDIMCILARI ---
const UI = {
    openInput: function(type) {
        Game.inputType = type;
        document.getElementById('modal-input').style.display = 'flex';
        document.getElementById('inp-t').value = '';
        document.getElementById('inp-c').value = '';
        document.getElementById('inp-t').focus();
    },
    closeModals: function() {
        document.querySelectorAll('.modal').forEach(m => m.style.display='none');
    }
};

// Ba≈ülat
Game.init();

// Enter tu≈üu desteƒüi
document.getElementById('inp-pass').addEventListener('keydown', e => { if(e.key==='Enter') Admin.login(); });
</script>
</body>
</html>
