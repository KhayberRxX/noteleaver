<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Leave a Note | Meta-Rooms</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --p: #00ff88; --p-rgb: 0, 255, 136;
            --bg: #010101; --card-bg: rgba(15, 15, 15, 0.95);
            --border: rgba(255, 255, 255, 0.07);
            --danger: #ff2255;
            --text-main: #e0e0e0; --text-light: #888;
            --grid-color: rgba(255, 255, 255, 0.02);
            --grid-size: 80px;
        }

        /* --- Global Reset & Base Styles --- */
        * { box-sizing: border-box; outline: none; -webkit-font-smoothing: antialiased; }
        body, html { 
            margin: 0; padding: 0; width: 100vw; height: 100vh; 
            overflow: hidden; background: var(--bg); color: var(--text-main);
            font-family: 'Inter', sans-serif; cursor: none !important;
            user-select: none;
        }

        /* --- Custom Cursor --- */
        #custom-cursor {
            width: 12px; height: 12px; background: var(--p); border-radius: 50%;
            position: fixed; pointer-events: none; z-index: 1000000;
            box-shadow: 0 0 15px var(--p);
            transition: transform 0.05s ease-out; /* Daha hƒ±zlƒ± takip */
        }

        /* --- Main Stage & Camera --- */
        #viewport { width: 100%; height: 100%; position: relative; overflow: hidden; }
        #camera {
            position: absolute;
            width: 100000px; height: 100000px; /* B√ºy√ºk d√ºnya */
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: var(--grid-size) var(--grid-size);
            transform-origin: 0 0;
            will-change: transform;
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); /* Yumu≈üak kamera ge√ßi≈üleri */
        }

        /* --- Top Bar: Room Navigation --- */
        #top-bar {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(15px);
            padding: 15px 30px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 20000;
        }
        #room-name {
            font-family: 'JetBrains Mono', monospace; font-size: 18px;
            color: var(--p); font-weight: bold; letter-spacing: 1px;
            cursor: pointer;
        }
        #room-name:hover { text-decoration: underline; }

        /* --- HUD (Bottom Left) --- */
        #hud {
            position: fixed; bottom: 20px; left: 20px;
            display: flex; gap: 10px; z-index: 15000; pointer-events: none;
        }
        .hud-chip {
            background: var(--card-bg); border: 1px solid var(--border);
            padding: 10px 18px; border-radius: 25px; font-size: 12px;
            font-family: 'JetBrains Mono', monospace; color: var(--text-light);
        }
        .hud-chip span { color: var(--p); font-weight: bold; }

        /* --- Context Menu (Right Click) --- */
        #context-menu {
            position: fixed; display: none; flex-direction: column; width: 220px;
            background: var(--card-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 15px;
            z-index: 50000; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .ctx-item {
            padding: 12px 15px; display: flex; align-items: center; gap: 10px;
            border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600;
            color: var(--text-main);
        }
        .ctx-item:hover { background: var(--p); color: black; }
        .ctx-divider { height: 1px; background: var(--border); margin: 5px 0; }

        /* --- Modals (Pop-ups for input) --- */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px); z-index: 40000; display: none;
            align-items: center; justify-content: center;
        }
        .modal {
            background: var(--card-bg); border: 1px solid var(--p);
            padding: 40px; border-radius: 25px; width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
        }
        .modal input, .modal textarea {
            width: 100%; background: #000; border: 1px solid #333;
            color: var(--text-main); padding: 15px; margin-bottom: 15px;
            border-radius: 10px; font-size: 15px;
        }
        .modal button {
            width: 100%; padding: 15px; background: var(--p); border: none;
            border-radius: 10px; font-weight: bold; color: black; cursor: pointer;
            transition: 0.2s;
        }
        .modal button:hover { opacity: 0.9; }

        /* --- Entities (Notes, Libraries, Books) --- */
        .entity {
            position: absolute; padding: 20px; background: var(--card-bg);
            border: 1px solid var(--border); border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            transition: transform 0.2s ease-out;
            min-width: 200px;
            pointer-events: all;
        }
        .entity:hover { border-color: var(--p); transform: translateY(-5px); }
        .entity h3 { margin: 0 0 8px 0; color: var(--p); font-size: 18px; }
        .entity p { margin: 0; color: var(--text-light); font-size: 14px; line-height: 1.6; }

        /* K√ºt√ºphane √ñzel Stil */
        .entity.library {
            border-color: #00aaff;
            box-shadow: 0 0 20px rgba(0, 170, 255, 0.3);
            cursor: pointer;
        }
        .entity.library h3 { color: #00aaff; }

        /* Kitap √ñzel Stil */
        .entity.book {
            background: #200000; /* Kƒ±rmƒ±zƒ± tonlarƒ±nda kitap */
            border-color: var(--danger);
            color: var(--text-main);
        }
        .entity.book h3 { color: var(--danger); }

    </style>
</head>
<body>

<div id="custom-cursor"></div>

<div id="top-bar">
    <div id="room-name" onclick="Engine.enterRoom('main')">ANA EVREN</div>
</div>

<div id="hud">
    <div class="hud-chip">POS: <span id="hud-pos">0, 0</span></div>
    <div class="hud-chip">ZOOM: <span id="hud-zoom">100%</span></div>
    <div class="hud-chip" style="pointer-events:all; cursor:pointer" onclick="Engine.focusCenter()">üè† SPAWN</div>
</div>

<div id="context-menu">
    <div class="ctx-item" data-type="note">üìù Not Bƒ±rak</div>
    <div class="ctx-item" data-type="library">üìö K√ºt√ºphane Kur</div>
    <div class="ctx-divider"></div>
    <div class="ctx-item" data-type="admin" style="color:var(--danger)">‚öôÔ∏è Admin Paneli</div>
</div>

<div id="modal-overlay">
    <div class="modal">
        <h2 id="modal-title" style="margin-top:0;">Yeni ƒ∞√ßerik Ekle</h2>
        <input type="text" id="modal-input-title" placeholder="Ba≈ülƒ±k (√ñrn: Mars K√ºt√ºphanesi)">
        <textarea id="modal-input-content" rows="5" placeholder="ƒ∞√ßerik (√ñrn: Uzay ara≈ütƒ±rmalarƒ± hakkƒ±nda bilgiler...)"></textarea>
        <button id="modal-submit-btn">YAYINLA</button>
        <p onclick="Engine.closeModal()" style="text-align:center; color:var(--text-light); cursor:pointer; margin-top:20px;">ƒ∞ptal</p>
    </div>
</div>

<div id="viewport">
    <div id="camera">
        <div style="position:absolute; left:50000px; top:50000px; width:200px; height:200px; transform:translate(-50%,-50%); border:2px dashed var(--p); border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--p); font-weight:bold; font-size:20px; opacity:0.6;">SPAWN</div>
    </div>
</div>

<script>
/**
 * LEAVE A NOTE: META-ROOMS ENGINE (v10.0)
 * Geli≈ümi≈ü Dinamik Oda ve ƒ∞√ßerik Y√∂netim Sistemi
 * Hasan i√ßin √∂zel olarak detaylandƒ±rƒ±lmƒ±≈ü ve optimize edilmi≈ütir.
 */
const Engine = {
    // --- KONFƒ∞G√úRASYON PARAMETRELERƒ∞ ---
    config: {
        SB_URL: "https://ssfgvjudifodfhovhpzx.supabase.co",
        SB_KEY: "sb_publishable_hBGvHNaGoHd_5cLAKVUhqA_N87pXWQo",
        WORLD_SIZE: 100000, // Haritanƒ±n toplam geni≈ülik/y√ºksekliƒüi
        SPAWN_COORD: 50000, // Ba≈ülangƒ±√ß noktasƒ±
        INITIAL_SCALE: 0.8, // Ba≈ülangƒ±√ß zoom seviyesi
        ZOOM_SPEED: 0.02,   // Her zoom adƒ±mƒ±nda √∂l√ßek deƒüi≈üim miktarƒ±
        MAX_SCALE: 2.5, MIN_SCALE: 0.1, // Zoom sƒ±nƒ±rlarƒ±
        CAMERA_TRANSITION_TIME: '0.6s cubic-bezier(0.23, 1, 0.32, 1)' // Kamera animasyon s√ºresi
    },

    // --- Sƒ∞STEM DURUM DEƒûƒ∞≈ûKENLERƒ∞ ---
    state: {
        db: null,           // Supabase istemcisi
        cameraX: 0, cameraY: 0, // Kameranƒ±n mevcut pozisyonu
        scale: 1,           // Mevcut zoom seviyesi
        isDragging: false,  // S√ºr√ºkleme durumu
        lastMouse: { x: 0, y: 0 }, // Son mouse konumu (s√ºr√ºkleme i√ßin)
        contextClickCoords: { x: 0, y: 0 }, // Saƒü tƒ±klandƒ±ƒüƒ±nda d√ºnya koordinatlarƒ±
        currentRoomId: 'main', // Mevcut oda ID'si ('main' veya k√ºt√ºphane ID'si)
        activeModalType: null, // A√ßƒ±k olan modal'ƒ±n tipi ('note', 'library', 'book')
        userId: localStorage.getItem('ln_meta_user_id') || `USR-${Math.random().toString(36).substr(2, 9)}` // Kullanƒ±cƒ± ID'si
    },

    // --- Sƒ∞STEM BA≈ûLANGICI ---
    init: async function() {
        console.log("OmniEngine v10.0 Ba≈ülatƒ±lƒ±yor...");
        this.state.db = supabase.createClient(this.config.SB_URL, this.config.SB_KEY);
        localStorage.setItem('ln_meta_user_id', this.state.userId);

        this.setupInitialCamera();
        this.bindGlobalEvents();
        await this.loadEntities(this.state.currentRoomId); // Ba≈ülangƒ±√ß odasƒ±nƒ± y√ºkle
        this.updateCameraTransform(false); // Kamera durumunu g√ºncelle, animasyon olmasƒ±n
        this.updateHUD();
    },

    // --- KAMERAYI BA≈ûLANGI√á NOKTASINA AYARLA ---
    setupInitialCamera: function() {
        // Ekranƒ±n tam ortasƒ±nƒ± d√ºnya merkezine hizala
        this.state.scale = this.config.INITIAL_SCALE;
        this.state.cameraX = -(this.config.SPAWN_COORD * this.state.scale) + (window.innerWidth / 2);
        this.state.cameraY = -(this.config.SPAWN_COORD * this.state.scale) + (window.innerHeight / 2);
    },

    // --- KLOBAL OLAY Dƒ∞NLEYƒ∞Cƒ∞LERƒ∞ ---
    bindGlobalEvents: function() {
        const cameraElement = document.getElementById('camera');

        // Mouse imleci takibi
        window.addEventListener('mousemove', (e) => {
            document.getElementById('custom-cursor').style.transform = `translate(${e.clientX}px, ${e.clientY}px)`;
            this.updateMouseWorldCoords(e); // HUD i√ßin koordinatlarƒ± g√ºncelle

            if (this.state.isDragging) {
                this.state.cameraX += e.clientX - this.state.lastMouse.x;
                this.state.cameraY += e.clientY - this.state.lastMouse.y;
                this.state.lastMouse = { x: e.clientX, y: e.clientY };
                this.updateCameraTransform(false); // S√ºr√ºklerken animasyon olmasƒ±n
            }
        });

        // S√ºr√ºkleme Ba≈ülangƒ±cƒ±
        window.addEventListener('mousedown', (e) => {
            if (e.button === 0 && (e.target === cameraElement || e.target.closest('.entity') === null)) { // Notlara tƒ±klayƒ±nca s√ºr√ºklemeyi engelle
                this.state.isDragging = true;
                this.state.lastMouse = { x: e.clientX, y: e.clientY };
                cameraElement.style.transition = 'none'; // S√ºr√ºklerken ge√ßi≈üi kapat
            }
        });

        // S√ºr√ºkleme Biti≈üi
        window.addEventListener('mouseup', () => {
            this.state.isDragging = false;
            cameraElement.style.transition = this.config.CAMERA_TRANSITION_TIME; // Tekrar a√ß
        });

        // Zoom (Tekerlek)
        window.addEventListener('wheel', (e) => {
            e.preventDefault();
            cameraElement.style.transition = 'none'; // Zoom anlƒ±k olmalƒ±
            
            const oldScale = this.state.scale;
            const delta = e.deltaY > 0 ? -this.config.ZOOM_SPEED : this.config.ZOOM_SPEED;
            let newScale = oldScale + delta;

            newScale = Math.min(Math.max(this.config.MIN_SCALE, newScale), this.config.MAX_SCALE);

            // Ekranƒ±n tam ortasƒ±nƒ± referans alarak zoom yap
            const screenCenterX = window.innerWidth / 2;
            const screenCenterY = window.innerHeight / 2;

            this.state.cameraX = screenCenterX - (screenCenterX - this.state.cameraX) * (newScale / oldScale);
            this.state.cameraY = screenCenterY - (screenCenterY - this.state.cameraY) * (newScale / oldScale);
            
            this.state.scale = newScale;
            this.updateCameraTransform(false);
            this.updateHUD();
        }, { passive: false });

        // Saƒü Tƒ±k (Context Menu)
        window.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            // Saƒü tƒ±klanan yerin d√ºnya koordinatlarƒ±nƒ± kaydet
            const cameraRect = cameraElement.getBoundingClientRect();
            this.state.contextClickCoords = {
                x: Math.round((e.clientX - cameraRect.left) / this.state.scale),
                y: Math.round((e.clientY - cameraRect.top) / this.state.scale)
            };

            // Men√ºy√º a√ß
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.display = 'flex';
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.top = `${e.clientY}px`;

            // Eƒüer k√ºt√ºphane odasƒ±ndaysak "K√ºt√ºphane Kur" se√ßeneƒüini gizle, "Kitap Ekle" se√ßeneƒüini g√∂ster
            const libraryOption = contextMenu.querySelector('[data-type="library"]');
            const noteOption = contextMenu.querySelector('[data-type="note"]');
            
            if (this.state.currentRoomId !== 'main') {
                if(libraryOption) libraryOption.style.display = 'none';
                if(noteOption) noteOption.textContent = 'üìù Not Bƒ±rak';
                if(!contextMenu.querySelector('[data-type="book"]')) {
                    const bookItem = document.createElement('div');
                    bookItem.className = 'ctx-item';
                    bookItem.setAttribute('data-type', 'book');
                    bookItem.innerHTML = 'üìñ Kitap Ekle';
                    bookItem.onclick = () => { Engine.openModal('book'); };
                    contextMenu.insertBefore(bookItem, noteOption.nextSibling); // Not altƒ±na ekle
                }
            } else {
                if(libraryOption) libraryOption.style.display = 'flex';
                if(noteOption) noteOption.textContent = 'üìù Not Bƒ±rak'; // Ana evrende not
                const bookItem = contextMenu.querySelector('[data-type="book"]');
                if(bookItem) bookItem.remove(); // Ana evrende kitabƒ± kaldƒ±r
            }
        });

        // Herhangi bir tƒ±klamada men√ºy√º kapat
        window.addEventListener('click', () => {
            document.getElementById('context-menu').style.display = 'none';
        });

        // Context men√ºdeki √∂ƒüelere tƒ±klama
        document.querySelectorAll('#context-menu .ctx-item').forEach(item => {
            item.onclick = (e) => {
                const type = item.getAttribute('data-type');
                if (type === 'admin') {
                    // Admin paneli i√ßin ayrƒ± bir akƒ±≈ü ba≈ülat
                    alert('Admin paneli daha sonra eklenecek.');
                } else {
                    this.openModal(type);
                }
                document.getElementById('context-menu').style.display = 'none';
            };
        });

        // Modal'daki Yayƒ±nla butonuna tƒ±klama
        document.getElementById('modal-submit-btn').onclick = () => {
            this.submitData();
        };
    },

    // --- KAMERA POZƒ∞SYONUNU G√úNCELLE ---
    updateCameraTransform: function(animated = true) {
        const cameraElement = document.getElementById('camera');
        cameraElement.style.transition = animated ? this.config.CAMERA_TRANSITION_TIME : 'none';
        cameraElement.style.transform = `translate(${this.state.cameraX}px, ${this.state.cameraY}px) scale(${this.state.scale})`;
        this.updateHUD(); // HUD'ƒ± her kamera hareketinde g√ºncelle
    },

    // --- HUD G√úNCELLEME ---
    updateHUD: function() {
        const cameraRect = document.getElementById('camera').getBoundingClientRect();
        const screenCenterX = window.innerWidth / 2;
        const screenCenterY = window.innerHeight / 2;
        
        const worldCenterX = Math.round((screenCenterX - cameraRect.left) / this.state.scale);
        const worldCenterY = Math.round((screenCenterY - cameraRect.top) / this.state.scale);

        document.getElementById('hud-pos').innerText = `${worldCenterX}, ${worldCenterY}`;
        document.getElementById('hud-zoom').innerText = `${(this.state.scale * 100).toFixed(0)}%`;
        document.getElementById('room-name').innerText = this.state.currentRoomId.toUpperCase();
    },

    // --- FARE D√úNYA KOORDƒ∞NATLARINI G√úNCELLE ---
    updateMouseWorldCoords: function(e) {
        const cameraRect = document.getElementById('camera').getBoundingClientRect();
        const worldX = Math.round((e.clientX - cameraRect.left) / this.state.scale);
        const worldY = Math.round((e.clientY - cameraRect.top) / this.state.scale);
        // Bu bilgi HUD'da g√∂sterilebilir veya ba≈üka yerde kullanƒ±labilir
    },

    // --- BELƒ∞RLƒ∞ Bƒ∞R KOORDƒ∞NATA ODAKLAN ---
    focusOnCoords: function(worldX, worldY, newScale = this.config.INITIAL_SCALE, animated = true) {
        this.state.scale = newScale;
        this.state.cameraX = -(worldX * this.state.scale) + (window.innerWidth / 2);
        this.state.cameraY = -(worldY * this.state.scale) + (window.innerHeight / 2);
        this.updateCameraTransform(animated);
    },

    // --- D√úNYA MERKEZƒ∞NE ODAKLAN (SPAWN) ---
    focusCenter: function() {
        this.focusOnCoords(this.config.SPAWN_COORD, this.config.SPAWN_COORD, this.config.INITIAL_SCALE, true);
    },

    // --- MODAL A√á ---
    openModal: function(type) {
        this.state.activeModalType = type;
        document.getElementById('modal-title').innerText = 
            type === 'note' ? 'Yeni Not Ekle' : 
            type === 'library' ? 'Yeni K√ºt√ºphane Kur' : 
            'Yeni Kitap Ekle';
        document.getElementById('modal-overlay').style.display = 'flex';
    },

    // --- MODAL KAPAT ---
    closeModal: function() {
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('modal-input-title').value = '';
        document.getElementById('modal-input-content').value = '';
        this.state.activeModalType = null;
    },

    // --- VERƒ∞ G√ñNDERME ---
    submitData: async function() {
        const title = document.getElementById('modal-input-title').value;
        const content = document.getElementById('modal-input-content').value;
        if (!title || !content) {
            alert("Ba≈ülƒ±k ve i√ßerik bo≈ü olamaz!");
            return;
        }

        const itemData = {
            type: this.state.activeModalType,
            title: title,
            content: content,
            x: this.state.contextClickCoords.x,
            y: this.state.contextClickCoords.y,
            user_id: this.state.userId,
            room_id: this.state.currentRoomId
        };

        const { data, error } = await this.state.db.from('items').insert([itemData]);

        if (error) {
            console.error("Veri kaydederken hata olu≈ütu:", error.message);
            alert("Veri kaydedilemedi: " + error.message);
        } else {
            console.log("Veri ba≈üarƒ±yla kaydedildi:", data);
            this.closeModal();
            this.renderEntity(itemData); // Yeni √∂ƒüeyi haritaya ekle
            this.focusOnCoords(itemData.x, itemData.y, this.config.INITIAL_SCALE, true); // Yeni √∂ƒüeye odaklan
        }
    },

    // --- ENTITY OLU≈ûTUR VE RENDER ET ---
    renderEntity: function(item) {
        // Eƒüer entity mevcut odaya aitse render et
        if (item.room_id !== this.state.currentRoomId) return;

        const entityDiv = document.createElement('div');
        entityDiv.className = `entity ${item.type}`; // 'note', 'library', 'book'
        entityDiv.style.left = `${item.x}px`;
        entityDiv.style.top = `${item.y}px`;
        entityDiv.innerHTML = `<h3>${item.title}</h3><p>${item.content}</p>`;
        
        // K√ºt√ºphaneye tƒ±klama olayƒ± ekle
        if (item.type === 'library') {
            entityDiv.onclick = (e) => {
                e.stopPropagation(); // Saƒü tƒ±k men√ºs√ºn√ºn a√ßƒ±lmasƒ±nƒ± engelle
                this.enterRoom(item.id); // K√ºt√ºphane odasƒ±na gir
            };
        }

        document.getElementById('camera').appendChild(entityDiv);
    },

    // --- VARLIKLARI (NOTLAR, K√úT√úPHANELER) Y√úKLE ---
    loadEntities: async function(roomId) {
        document.getElementById('camera').innerHTML = ''; // √ñnceki t√ºm entity'leri temizle (odalar arasƒ± ge√ßi≈ü i√ßin)
        const { data, error } = await this.state.db.from('items').select('*').eq('room_id', roomId);

        if (error) {
            console.error("Varlƒ±klar y√ºklenirken hata olu≈ütu:", error.message);
            return;
        }

        data.forEach(item => this.renderEntity(item));
        console.log(`Oda '${roomId}' i√ßin ${data.length} varlƒ±k y√ºklendi.`);
    },

    // --- ODAYA Gƒ∞Rƒ∞≈û YAP ---
    enterRoom: async function(newRoomId) {
        if (this.state.currentRoomId === newRoomId) return; // Zaten bu odadaysak bir ≈üey yapma

        this.state.currentRoomId = newRoomId;
        document.getElementById('room-name').innerText = newRoomId === 'main' ? 'ANA EVREN' : `K√úT√úPHANE: ${newRoomId}`;
        
        await this.loadEntities(newRoomId); // Yeni odanƒ±n varlƒ±klarƒ±nƒ± y√ºkle
        this.focusCenter(); // Her odaya giri≈üte merkeze odaklan
        console.log(`Odaya girildi: ${newRoomId}`);
    }
};

// Sadece DOM tamamen y√ºklendiƒüinde Engine'i ba≈ülat
document.addEventListener('DOMContentLoaded', () => {
    Engine.init();
});
</script>
</body>
</html>
