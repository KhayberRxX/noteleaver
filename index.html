<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave a Note | Pro Universe</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root {
            --p: #00ff88; --p-glow: rgba(0, 255, 136, 0.4);
            --bg: #050505; --s: #121212; --border: rgba(255,255,255,0.08);
            --danger: #ff3366;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; cursor: none !important; }
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: var(--bg); color: #fff; }

        /* --- CUSTOM CURSOR --- */
        #cursor {
            width: 15px; height: 15px; background: var(--p); border-radius: 50%;
            position: fixed; pointer-events: none; z-index: 100000;
            box-shadow: 0 0 20px var(--p-glow); transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* --- ENGINE: MAP & VIEWPORT --- */
        #viewport { width: 100vw; height: 100vh; position: relative; overflow: hidden; }
        #world {
            width: 120000px; height: 120000px; position: absolute;
            background-image: 
                radial-gradient(circle at center, #111 1px, transparent 1px),
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 100px 100px, 100px 100px, 100px 100px;
            transform-origin: 0 0; will-change: transform;
        }

        /* --- SAƒû TIK MEN√úS√ú (CONTEXT) --- */
        #ctx-menu {
            position: fixed; display: none; flex-direction: column; 
            width: 220px; background: rgba(10,10,10,0.9); backdrop-filter: blur(25px);
            border: 1px solid var(--border); border-radius: 20px; z-index: 90000;
            padding: 10px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            animation: menuOpen 0.2s ease-out;
        }
        @keyframes menuOpen { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .ctx-item {
            padding: 12px 15px; display: flex; align-items: center; gap: 12px;
            border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;
        }
        .ctx-item:hover { background: var(--p); color: #000; }

        /* --- ALT TASKBAR (Sadece Bilgi ve Admin ƒ∞√ßin) --- */
        #taskbar {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            background: rgba(15,15,15,0.8); backdrop-filter: blur(20px);
            padding: 12px 30px; border-radius: 40px; border: 1px solid var(--border);
            display: flex; gap: 30px; z-index: 10000; align-items: center;
        }
        .stat { font-size: 12px; font-weight: bold; color: #888; }
        .stat span { color: var(--p); }

        /* --- NOT KARTLARI --- */
        .node {
            position: absolute; padding: 25px; background: var(--s);
            border: 1px solid var(--border); border-radius: 24px;
            min-width: 280px; box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .node h3 { margin: 0 0 10px 0; color: var(--p); font-size: 20px; }
        .node p { color: #ccc; line-height: 1.6; margin-bottom: 15px; }

        /* --- MODALLAR --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(10px); z-index: 99998; display: none;
        }
        .modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 450px; background: #0a0a0a; border: 1px solid var(--p);
            border-radius: 35px; padding: 40px; z-index: 99999; display: none;
        }
        input, textarea {
            width: 100%; background: #000; border: 1px solid #222; 
            color: #fff; padding: 18px; border-radius: 15px; margin-bottom: 20px;
        }
        .submit-btn {
            width: 100%; padding: 18px; background: var(--p); border: none;
            border-radius: 15px; font-weight: 900; color: #000; cursor: pointer;
        }

        /* --- BAN Sƒ∞STEMƒ∞ --- */
        #ban-wrap {
            position: fixed; inset: 0; background: #000; z-index: 1000000;
            display: none; align-items: center; justify-content: center; text-align: center;
        }
    </style>
</head>
<body>

<div id="cursor"></div>

<div id="ban-wrap">
    <div>
        <h1 style="color:var(--danger); font-size: 50px;">ERƒ∞≈ûƒ∞M REDDEDƒ∞LDƒ∞</h1>
        <p>Kural ihlali nedeniyle 5 dakika uzakla≈ütƒ±rƒ±ldƒ±nƒ±z.</p>
        <div id="countdown" style="font-size: 40px; color: var(--p)">05:00</div>
    </div>
</div>

<div id="ctx-menu">
    <div class="ctx-item" onclick="openModal('note')">üìù Not Bƒ±rak</div>
    <div class="ctx-item" onclick="openModal('draw')">üé® √áizim Yap</div>
    <div class="ctx-item" onclick="openModal('library')">üìö K√ºt√ºphane Kur</div>
    <div style="height:1px; background:var(--border); margin:5px 0;"></div>
    <div class="ctx-item" style="color:var(--danger)" onclick="adminAuth()">‚öôÔ∏è Admin Giri≈üi</div>
</div>

<div id="taskbar">
    <div class="stat">USER_ID: <span id="uid">...</span></div>
    <div class="stat">LOC: <span id="pos">0, 0</span></div>
    <div class="stat">ZOOM: <span id="zm">1.0x</span></div>
</div>

<div id="viewport">
    <div id="world"></div>
</div>

<div class="modal-overlay" id="overlay" onclick="closeModal()"></div>
<div class="modal" id="modal">
    <h2 id="m-title" style="margin-top:0">Yeni ƒ∞√ßerik</h2>
    <input type="text" id="i-title" placeholder="Ba≈ülƒ±k...">
    <textarea id="i-content" rows="6" placeholder="ƒ∞√ßerik..."></textarea>
    <button class="submit-btn" onclick="publish()">D√úNYAYA G√ñNDER</button>
</div>

<script>
    const _SURL = "https://ssfgvjudifodfhovhpzx.supabase.co";
    const _SKEY = "sb_publishable_hBGvHNaGoHd_5cLAKVUhqA_N87pXWQo";
    const _db = supabase.createClient(_SURL, _SKEY);

    let scale = 1, x = -60000, y = -60000;
    let isDrag = false, sx, sy, curX, curY;
    let isAdmin = false;

    let myId = localStorage.getItem('ln_pro_id') || 'H-' + Math.floor(Math.random()*99999);
    localStorage.setItem('ln_pro_id', myId);
    document.getElementById('uid').innerText = myId;

    const world = document.getElementById('world');
    const cursor = document.getElementById('cursor');

    // --- CURSOR & COORDINATES ---
    window.onmousemove = (e) => {
        cursor.style.left = e.clientX + 'px';
        cursor.style.top = e.clientY + 'px';
        
        const rect = world.getBoundingClientRect();
        const mouseX = Math.round((e.clientX - rect.left) / scale);
        const mouseY = Math.round((e.clientY - rect.top) / scale);
        document.getElementById('pos').innerText = `${mouseX}, ${mouseY}`;

        if(isDrag) {
            x += (e.clientX - sx);
            y += (e.clientY - sy);
            sx = e.clientX; sy = e.clientY;
            updateWorld();
        }
    };

    // --- ZOOM ---
    window.onwheel = (e) => {
        const d = e.deltaY > 0 ? 0.9 : 1.1;
        scale = Math.min(Math.max(0.1, scale * d), 3);
        document.getElementById('zm').innerText = scale.toFixed(1) + 'x';
        updateWorld();
    };

    // --- DRAG & SAƒû TIK ---
    window.onmousedown = (e) => {
        if(e.button === 0 && (e.target.id === 'viewport' || e.target.id === 'world')) {
            isDrag = true; sx = e.clientX; sy = e.clientY;
        }
    };
    window.onmouseup = () => isDrag = false;

    window.oncontextmenu = (e) => {
        e.preventDefault();
        const rect = world.getBoundingClientRect();
        curX = Math.round((e.clientX - rect.left) / scale);
        curY = Math.round((e.clientY - rect.top) / scale);

        const menu = document.getElementById('ctx-menu');
        menu.style.display = 'flex';
        menu.style.left = e.clientX + 'px';
        menu.style.top = e.clientY + 'px';
    };
    window.onclick = () => document.getElementById('ctx-menu').style.display = 'none';

    function updateWorld() {
        world.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
    }

    // --- MODAL & VERƒ∞ ---
    let activeType = 'note';
    function openModal(type) {
        activeType = type;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal').style.display = 'block';
    }
    function closeModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('modal').style.display = 'none';
    }

    async function publish() {
        const title = document.getElementById('i-title').value;
        const content = document.getElementById('i-content').value;
        if(!title || !content) return;

        const { error } = await _db.from('items').insert([{
            title, content, x: curX, y: curY, type: activeType, user_id: myId
        }]);

        if(!error) location.reload();
        else alert("Sistem Hatasƒ±: " + error.message);
    }

    async function load() {
        const { data } = await _db.from('items').select('*');
        data?.forEach(obj => {
            const el = document.createElement('div');
            el.className = 'node';
            el.style.left = obj.x + 'px';
            el.style.top = obj.y + 'px';
            el.innerHTML = `
                <h3>${obj.title}</h3>
                <p>${obj.content}</p>
                <div style="display:flex; gap:10px">
                    <button onclick="rep(${obj.id})" style="background:none; border:1px solid #333; color:#555; font-size:10px; cursor:pointer">üö© RAPOR</button>
                    <button class="adm-btn" onclick="ban('${obj.user_id}', ${obj.id})" style="display:none; color:red; border:1px solid red; background:none; cursor:pointer">Sƒ∞L & BAN</button>
                </div>
            `;
            world.appendChild(el);
        });
        updateWorld();
        checkBan();
    }

    // --- ADMƒ∞N & BAN ---
    async function checkBan() {
        const { data } = await _db.from('site_users').select('banned_until').eq('user_id', myId).single();
        if(data && new Date(data.banned_until) > new Date()) {
            document.getElementById('ban-wrap').style.display = 'flex';
        }
    }

    function adminAuth() {
        const p = prompt("Y√∂netici ≈ûifresi:");
        if(p === "Hasan0245") {
            isAdmin = true;
            document.querySelectorAll('.adm-btn').forEach(b => b.style.display = 'block');
            alert("ADMƒ∞N YETKƒ∞Sƒ∞ VERƒ∞LDƒ∞");
        }
    }

    async function ban(uid, itemId) {
        if(!confirm("Bu kullanƒ±cƒ± 5 dakika banlansƒ±n mƒ±?")) return;
        await _db.from('items').delete().eq('id', itemId);
        const bTime = new Date(Date.now() + 5 * 60000).toISOString();
        await _db.from('site_users').upsert({ user_id: uid, banned_until: bTime });
        location.reload();
    }

    window.onload = load;
</script>
</body>
</html>
