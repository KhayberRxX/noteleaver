<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leave a Note</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#10141a; --panel2:#0f1318; --text:#e7eef8; --muted:#93a4b7;
      --accent:#7c5cff; --danger:#ff4d4d; --note:#1a2230; --stroke:#223044; --lib:#1c2a20; --libStroke:#2bff6a;
      --shadow: 0 14px 40px rgba(0,0,0,.55);
      --r:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;overflow:hidden}
    a{color:inherit}

    /* Top bar */
    #topbar{position:fixed;inset:12px 12px auto 12px;display:flex;align-items:center;justify-content:space-between;gap:12px;z-index:50;pointer-events:none}
    .brand{display:flex;align-items:center;gap:10px;pointer-events:auto}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(145deg,rgba(124,92,255,.25),rgba(124,92,255,.05));border:1px solid rgba(124,92,255,.35);box-shadow:var(--shadow);display:grid;place-items:center}
    .logo svg{display:block}
    .brand h1{margin:0;font-size:15px;letter-spacing:.2px}
    .brand .sub{color:var(--muted);font-size:12px;margin-top:1px}

    .actions{display:flex;align-items:center;gap:10px;pointer-events:auto}
    .chip{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid rgba(255,255,255,.08);border-radius:999px;background:rgba(16,20,26,.7);backdrop-filter: blur(10px);box-shadow: 0 10px 30px rgba(0,0,0,.35)}
    .chip b{font-weight:650}
    .btnIcon{width:38px;height:38px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(16,20,26,.7);backdrop-filter: blur(10px);display:grid;place-items:center;cursor:pointer;user-select:none;box-shadow: 0 10px 30px rgba(0,0,0,.35)}
    .btnIcon:hover{border-color:rgba(255,255,255,.18)}
    .btnIcon:active{transform:translateY(1px)}

    /* Board */
    #boardWrap{position:fixed;inset:0;overflow:hidden;}
    #board{position:absolute;left:0;top:0;transform:translate3d(0,0,0);will-change:transform}

    /* Subtle infinite-grid feel */
    #grid{position:fixed;inset:-2000px;pointer-events:none;opacity:.55;mix-blend-mode:screen}
    #grid::before{
      content:"";position:absolute;inset:0;
      background:
        radial-gradient(circle at 1px 1px, rgba(255,255,255,.06) 1px, transparent 0) 0 0/44px 44px,
        radial-gradient(circle at 1px 1px, rgba(124,92,255,.10) 1px, transparent 0) 0 0/220px 220px;
      filter: blur(.0px);
    }

    /* Note cards */
    .item{position:absolute;min-width:220px;max-width:320px;border-radius:var(--r);border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(26,34,48,.92), rgba(16,20,26,.90));
      box-shadow: 0 14px 35px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .item.library{
      min-width:320px;max-width:420px;
      border:1px solid rgba(43,255,106,.45);
      box-shadow: 0 18px 48px rgba(0,0,0,.6);
      background:linear-gradient(180deg, rgba(28,42,32,.92), rgba(16,20,26,.90));
    }
    .item .head{padding:10px 12px 6px 12px;display:flex;align-items:flex-start;gap:10px}
    .badge{width:26px;height:26px;border-radius:10px;display:grid;place-items:center;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.05);flex:0 0 auto}
    .library .badge{border-color:rgba(43,255,106,.35);background:rgba(43,255,106,.08)}
    .title{font-weight:700;letter-spacing:.2px;word-break:break-word}
    .meta{color:var(--muted);font-size:11px;margin-top:2px}
    .item .body{padding:0 12px 12px 12px;color:#d7e2f0;white-space:pre-wrap;word-break:break-word}
    .item .foot{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;border-top:1px solid rgba(255,255,255,.08);background:rgba(15,19,24,.55)}
    .small{font-size:11px;color:var(--muted)}
    .dangerBtn{display:none;gap:8px;align-items:center;border:none;border-radius:12px;padding:8px 10px;background:rgba(255,77,77,.14);
      color:#ffd7d7;border:1px solid rgba(255,77,77,.28);cursor:pointer}
    .dangerBtn:hover{background:rgba(255,77,77,.18)}
    .dangerBtn:active{transform:translateY(1px)}

    /* Context menu */
    #menu{position:fixed;z-index:80;display:none;min-width:220px;max-width:280px;border-radius:16px;background:rgba(16,20,26,.86);
      border:1px solid rgba(255,255,255,.10);box-shadow:var(--shadow);backdrop-filter: blur(12px);overflow:hidden}
    #menu .mhead{padding:12px 12px 10px;border-bottom:1px solid rgba(255,255,255,.08)}
    #menu .mhead b{display:block}
    #menu .mhead span{color:var(--muted);font-size:12px}
    #menu button{width:100%;text-align:left;padding:10px 12px;background:transparent;border:none;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:space-between}
    #menu button:hover{background:rgba(255,255,255,.06)}
    #menu button small{color:var(--muted)}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:120}
    .modal{width:min(520px, calc(100% - 24px));border-radius:18px;background:rgba(16,20,26,.9);border:1px solid rgba(255,255,255,.10);box-shadow:var(--shadow);backdrop-filter: blur(12px)}
    .modal header{padding:14px 14px 10px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between}
    .modal header b{font-size:13px;letter-spacing:.2px}
    .modal .content{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1 1 220px;display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    input,textarea{width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(10,12,15,.7);color:var(--text);padding:10px 12px;outline:none}
    textarea{min-height:110px;resize:vertical}
    input:focus,textarea:focus{border-color:rgba(124,92,255,.45)}
    .modal .actions{padding:12px 14px 14px;display:flex;gap:10px;justify-content:flex-end}
    .btn{border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text);padding:10px 12px;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn.primary{border-color:rgba(124,92,255,.35);background:rgba(124,92,255,.16)}
    .btn.primary:hover{background:rgba(124,92,255,.20)}
    .btn:active{transform:translateY(1px)}

    /* HUD coords */
    #coords{position:fixed;right:12px;bottom:12px;z-index:60;pointer-events:none}
    #coords .chip{pointer-events:none}

    /* Toast */
    #toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);z-index:200;display:none}
    #toast .chip{border-color:rgba(255,255,255,.10)}

    /* Mobile hint */
    @media (max-width:720px){
      .brand h1{font-size:14px}
      .item{min-width:200px}
      .item.library{min-width:280px}
    }
  </style>
</head>
<body>
  <div id="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M7 6v12h3" stroke="rgba(231,238,248,.95)" stroke-width="2" stroke-linecap="round"/>
          <path d="M14 6v12" stroke="rgba(231,238,248,.95)" stroke-width="2" stroke-linecap="round"/>
          <path d="M14 12c0-3 2-5 5-5" stroke="rgba(124,92,255,.9)" stroke-width="2" stroke-linecap="round"/>
          <path d="M14 12c0 3 2 5 5 5" stroke="rgba(124,92,255,.9)" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h1>Leave a Note</h1>
        <div class="sub">Sonsuz harita ‚Ä¢ Notlar &amp; K√ºt√ºphaneler</div>
      </div>
    </div>

    <div class="actions">
      <div class="chip" title="K√ºt√ºphane hakkƒ±">
        <span aria-hidden="true">üìö</span>
        <span>Kalan: <b id="credits">3</b></span>
      </div>
      <div class="btnIcon" id="gear" title="Admin">
        <span aria-hidden="true">‚öôÔ∏è</span>
      </div>
    </div>
  </div>

  <div id="boardWrap">
    <div id="grid"></div>
    <div id="board" aria-label="Sonsuz harita"></div>
  </div>

  <div id="coords"><div class="chip"><span style="color:var(--muted)">X</span> <b id="cx">0</b> <span style="color:var(--muted)">Y</span> <b id="cy">0</b></div></div>

  <div id="menu" role="menu" aria-hidden="true">
    <div class="mhead"><b>Yeni i√ßerik ekle</b><span id="menupos">(0, 0)</span></div>
    <button id="addNote" role="menuitem"><span>üìù Not</span><small>Normal</small></button>
    <button id="addLib" role="menuitem"><span>üìö K√ºt√ºphane</span><small>Ye≈üil √ßer√ßeve</small></button>
  </div>

  <div class="overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <b id="modalTitle">Ekle</b>
        <div class="btnIcon" id="closeModal" title="Kapat" style="width:34px;height:34px;border-radius:12px;box-shadow:none">‚úï</div>
      </header>
      <div class="content">
        <div class="row">
          <div class="field">
            <label class="small" for="t">Ba≈ülƒ±k</label>
            <input id="t" autocomplete="off" maxlength="80" placeholder="Ba≈ülƒ±k..." />
          </div>
        </div>
        <div class="field">
          <label class="small" for="c">ƒ∞√ßerik</label>
          <textarea id="c" maxlength="4000" placeholder="ƒ∞√ßerik..."></textarea>
        </div>
        <div class="small" id="hint">Saƒü tƒ±k / uzun basƒ±≈ü ile ekle men√ºs√º a√ßƒ±lƒ±r. S√ºr√ºkleyerek haritayƒ± kaydƒ±r.</div>
      </div>
      <div class="actions">
        <button class="btn" id="cancel">Vazge√ß</button>
        <button class="btn primary" id="save">Kaydet</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="adminOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
      <header>
        <b id="adminTitle">Admin Giri≈üi</b>
        <div class="btnIcon" id="closeAdmin" title="Kapat" style="width:34px;height:34px;border-radius:12px;box-shadow:none">‚úï</div>
      </header>
      <div class="content">
        <div class="field">
          <label class="small" for="pw">≈ûifre</label>
          <input id="pw" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <div class="small" id="adminState" style="margin-top:6px;color:var(--muted)">‚ö†Ô∏è Gizli admin sistemi</div>
      </div>
      <div class="actions">
        <button class="btn" id="adminCancel">Kapat</button>
        <button class="btn primary" id="adminOk">Giri≈ü</button>
      </div>
    </div>
  </div>

  <div id="toast"><div class="chip" id="toastText">...</div></div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ====== Config ======
    const SUPABASE_URL = "https://ssfgvjudifodfhovhpzx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_hBGvHNaGoHd_5cLAKVUhqA_N87pXWQo";
    const TABLE = "items";

    // ====== Helpers ======
    const $ = (s, r=document) => r.querySelector(s);
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const uid = () => (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(16).slice(2)));
    const fmt = (n)=> (n===0?"0": (Math.round(n)).toString());
    const toast = (msg, ms=1800)=>{
      const el = $("#toast"), t=$("#toastText");
      t.textContent = msg;
      el.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.style.display="none", ms);
    };

    // ====== State ======
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: false } });

    const boardWrap = $("#boardWrap");
    const board = $("#board");
    const grid = $("#grid");

    const menu = $("#menu");
    const menupos = $("#menupos");
    const addNoteBtn = $("#addNote");
    const addLibBtn = $("#addLib");

    const modalOverlay = $("#modalOverlay");
    const closeModal = $("#closeModal");
    const cancelBtn = $("#cancel");
    const saveBtn = $("#save");
    const modalTitle = $("#modalTitle");
    const inputT = $("#t");
    const inputC = $("#c");

    const gear = $("#gear");
    const adminOverlay = $("#adminOverlay");
    const closeAdmin = $("#closeAdmin");
    const adminCancel = $("#adminCancel");
    const adminOk = $("#adminOk");
    const pw = $("#pw");
    const adminState = $("#adminState");

    const cx = $("#cx"), cy = $("#cy");
    const creditsEl = $("#credits");

    const LS_USER = "ln_user_id";
    const LS_CREDITS = "ln_library_credits";
    const LS_ADMIN = "ln_admin";

    const user_id = localStorage.getItem(LS_USER) || (localStorage.setItem(LS_USER, uid()), localStorage.getItem(LS_USER));
    let libraryCredits = Number(localStorage.getItem(LS_CREDITS));
    if (!Number.isFinite(libraryCredits)) libraryCredits = 3;
    libraryCredits = clamp(libraryCredits, 0, 999);
    localStorage.setItem(LS_CREDITS, String(libraryCredits));

    let isAdmin = sessionStorage.getItem(LS_ADMIN) === "1";

    const items = new Map(); // id -> item row

    // Camera/pan
    let camX = 0, camY = 0; // translate pixels
    let dragging = false;
    let dragStart = {x:0,y:0,cx:0,cy:0};
    let mouse = {x:0,y:0, wx:0, wy:0};
    let ctxWorld = {x:0,y:0};
    let pendingType = "note";

    function setCredits(v){
      libraryCredits = clamp(Number(v)||0,0,999);
      localStorage.setItem(LS_CREDITS, String(libraryCredits));
      creditsEl.textContent = String(libraryCredits);
    }
    setCredits(libraryCredits);

    function setAdmin(on){
      isAdmin = !!on;
      sessionStorage.setItem(LS_ADMIN, on?"1":"0");
      adminState.textContent = on ? "‚úÖ Admin mod aktif" : "‚ö†Ô∏è Gizli admin sistemi";
      renderAll();
    }
    setAdmin(isAdmin);

    function worldFromClient(clientX, clientY){
      // world coordinates in px relative to world origin (0,0)
      const r = boardWrap.getBoundingClientRect();
      const x = clientX - r.left - camX;
      const y = clientY - r.top - camY;
      return {x, y};
    }

    function clientFromWorld(wx, wy){
      const r = boardWrap.getBoundingClientRect();
      return { x: r.left + camX + wx, y: r.top + camY + wy };
    }

    function applyTransform(){
      board.style.transform = `translate3d(${camX}px, ${camY}px, 0)`;
      // Move grid with camera for true infinite feel
      grid.style.transform = `translate3d(${camX}px, ${camY}px, 0)`;
    }

    function updateCoords(){
      cx.textContent = fmt(mouse.wx);
      cy.textContent = fmt(mouse.wy);
    }

    // ====== UI: menu & modals ======
    function hideMenu(){ menu.style.display = "none"; menu.setAttribute("aria-hidden","true"); }
    function showMenuAt(clientX, clientY, wx, wy){
      ctxWorld = {x: wx, y: wy};
      menupos.textContent = `(${fmt(wx)}, ${fmt(wy)})`;

      const pad=10;
      menu.style.display = "block";
      menu.setAttribute("aria-hidden","false");
      // Place then clamp in viewport
      const mw = 260;
      const mh = 140;
      const x = clamp(clientX + 8, pad, window.innerWidth - mw - pad);
      const y = clamp(clientY + 8, pad, window.innerHeight - mh - pad);
      menu.style.left = x + "px";
      menu.style.top = y + "px";

      // Update library button hint
      addLibBtn.querySelector("small").textContent = libraryCredits>0 ? `Ye≈üil √ßer√ßeve ‚Ä¢ Kalan ${libraryCredits}` : "Hakkƒ±n yok";
      addLibBtn.style.opacity = libraryCredits>0 ? "1" : ".45";
    }

    function openCreateModal(type){
      pendingType = type;
      hideMenu();
      modalTitle.textContent = type === "library" ? "K√ºt√ºphane Ekle" : "Not Ekle";
      inputT.value = "";
      inputC.value = "";
      modalOverlay.style.display = "flex";
      modalOverlay.setAttribute("aria-hidden","false");
      setTimeout(()=> inputT.focus(), 0);
    }
    function closeCreateModal(){
      modalOverlay.style.display = "none";
      modalOverlay.setAttribute("aria-hidden","true");
    }

    function openAdmin(){
      pw.value = "";
      adminOverlay.style.display = "flex";
      adminOverlay.setAttribute("aria-hidden","false");
      setTimeout(()=> pw.focus(), 0);
    }
    function closeAdminModal(){
      adminOverlay.style.display = "none";
      adminOverlay.setAttribute("aria-hidden","true");
    }

    // ====== Render ======
    function iconFor(type){
      return type === "library" ? "üìö" : "üìù";
    }

    function elItem(row){
      const div = document.createElement("div");
      div.className = "item" + (row.type === "library" ? " library" : "");
      div.dataset.id = row.id;

      div.innerHTML = `
        <div class="head">
          <div class="badge" aria-hidden="true">${iconFor(row.type)}</div>
          <div style="min-width:0">
            <div class="title"></div>
            <div class="meta"></div>
          </div>
        </div>
        <div class="body"></div>
        <div class="foot">
          <div class="small">#${String(row.id).slice(0,6)}</div>
          <button class="dangerBtn" type="button">üóëÔ∏è Sƒ∞L</button>
        </div>
      `;

      div.querySelector(".title").textContent = row.title || (row.type === "library" ? "(K√ºt√ºphane)" : "(Not)");
      div.querySelector(".body").textContent = row.content || "";
      div.querySelector(".meta").textContent = `X ${fmt(row.x)} ‚Ä¢ Y ${fmt(row.y)}`;

      // Position
      div.style.left = (Number(row.x)||0) + "px";
      div.style.top  = (Number(row.y)||0) + "px";

      const del = div.querySelector(".dangerBtn");
      if (isAdmin){
        del.style.display = "inline-flex";
        del.addEventListener("click", (e)=>{
          e.stopPropagation();
          deleteItem(row.id);
        });
      }

      // Prevent dragging from selecting
      div.addEventListener("mousedown", (e)=>{ e.stopPropagation(); });
      div.addEventListener("touchstart", (e)=>{ e.stopPropagation(); }, {passive:true});
      return div;
    }

    function renderAll(){
      board.innerHTML = "";
      for (const row of items.values()) board.appendChild(elItem(row));
    }

    function upsertRow(row){
      if (!row || row.id==null) return;
      items.set(row.id, row);
      // Update or insert minimal
      const existing = board.querySelector(`.item[data-id="${CSS.escape(String(row.id))}"]`);
      if (existing){
        existing.className = "item" + (row.type === "library" ? " library" : "");
        existing.style.left = (Number(row.x)||0) + "px";
        existing.style.top  = (Number(row.y)||0) + "px";
        existing.querySelector(".title").textContent = row.title || (row.type === "library" ? "(K√ºt√ºphane)" : "(Not)");
        existing.querySelector(".body").textContent = row.content || "";
        existing.querySelector(".meta").textContent = `X ${fmt(row.x)} ‚Ä¢ Y ${fmt(row.y)}`;
        const del = existing.querySelector(".dangerBtn");
        del.style.display = isAdmin ? "inline-flex" : "none";
        if (isAdmin && !del.dataset.bound){
          del.dataset.bound = "1";
          del.addEventListener("click", (e)=>{ e.stopPropagation(); deleteItem(row.id); });
        }
      } else {
        board.appendChild(elItem(row));
      }
    }

    function removeRow(id){
      items.delete(id);
      const el = board.querySelector(`.item[data-id="${CSS.escape(String(id))}"]`);
      if (el) el.remove();
    }

    // ====== Data ======
    async function loadItems(){
      const { data, error } = await supabase.from(TABLE).select("id,title,content,x,y,type,user_id").order("id", { ascending: true });
      if (error){
        console.error(error);
        toast("Veri okunamadƒ± (RLS / izin?)");
        return;
      }
      items.clear();
      for (const row of data || []) items.set(row.id, row);
      renderAll();
    }

    async function createItem(type, title, content, wx, wy){
      title = (title||"").trim();
      content = (content||"").trim();
      if (!title && !content){ toast("Bo≈ü i√ßerik kaydedilmez"); return; }

      const payload = {
        title: title || (type==="library"?"Yeni K√ºt√ºphane":"Yeni Not"),
        content: content || "",
        x: Math.round(wx),
        y: Math.round(wy),
        type,
        user_id
      };

      const { data, error } = await supabase.from(TABLE).insert(payload).select("id,title,content,x,y,type,user_id").single();
      if (error){
        console.error(error);
        toast("Kaydedilemedi (izin?)");
        // If library was attempted, revert credit locally
        return false;
      }
      upsertRow(data);
      return true;
    }

    async function deleteItem(id){
      if (!isAdmin){ toast("Admin deƒüilsin"); return; }
      const { error } = await supabase.from(TABLE).delete().eq("id", id);
      if (error){ console.error(error); toast("Silinemedi (izin?)"); return; }
      removeRow(id);
      toast("Silindi");
    }

    function subscribeRealtime(){
      // If Realtime is enabled on items table
      const channel = supabase.channel("ln-items")
        .on("postgres_changes", { event: "*", schema: "public", table: TABLE }, (payload)=>{
          const e = payload.eventType;
          if (e === "INSERT" || e === "UPDATE") upsertRow(payload.new);
          else if (e === "DELETE") removeRow(payload.old?.id);
        })
        .subscribe((status)=>{
          if (status === "SUBSCRIBED") console.log("Realtime: subscribed");
        });
      return channel;
    }

    // ====== Interactions ======
    function onPointerMove(e){
      const p = ("touches" in e) ? e.touches[0] : e;
      mouse.x = p.clientX; mouse.y = p.clientY;
      const w = worldFromClient(mouse.x, mouse.y);
      mouse.wx = w.x; mouse.wy = w.y;
      updateCoords();
    }

    // Pan with left mouse button (or single finger drag)
    boardWrap.addEventListener("mousedown", (e)=>{
      if (e.button !== 0) return; // only left
      dragging = true;
      dragStart = {x:e.clientX,y:e.clientY,cx:camX,cy:camY};
      hideMenu();
    });
    window.addEventListener("mousemove", (e)=>{
      onPointerMove(e);
      if (!dragging) return;
      camX = dragStart.cx + (e.clientX - dragStart.x);
      camY = dragStart.cy + (e.clientY - dragStart.y);
      applyTransform();
    }, {passive:true});
    window.addEventListener("mouseup", ()=>{ dragging = false; });

    // Touch pan + long press menu
    let longPressT = null;
    let touchDragging = false;
    let touchStart = null;

    boardWrap.addEventListener("touchstart", (e)=>{
      if (!e.touches?.length) return;
      const t = e.touches[0];
      touchDragging = true;
      touchStart = {x:t.clientX,y:t.clientY,cx:camX,cy:camY, moved:false};
      hideMenu();

      clearTimeout(longPressT);
      longPressT = setTimeout(()=>{
        if (!touchStart || touchStart.moved) return;
        const w = worldFromClient(touchStart.x, touchStart.y);
        showMenuAt(touchStart.x, touchStart.y, w.x, w.y);
      }, 520);
    }, {passive:true});

    boardWrap.addEventListener("touchmove", (e)=>{
      onPointerMove(e);
      if (!touchDragging || !touchStart) return;
      const t = e.touches[0];
      const dx = t.clientX - touchStart.x;
      const dy = t.clientY - touchStart.y;
      if (Math.hypot(dx,dy) > 6) touchStart.moved = true;
      camX = touchStart.cx + dx;
      camY = touchStart.cy + dy;
      applyTransform();
    }, {passive:true});

    boardWrap.addEventListener("touchend", ()=>{
      touchDragging = false;
      touchStart = null;
      clearTimeout(longPressT);
    });

    // Right click menu
    boardWrap.addEventListener("contextmenu", (e)=>{
      e.preventDefault();
      const w = worldFromClient(e.clientX, e.clientY);
      showMenuAt(e.clientX, e.clientY, w.x, w.y);
    });

    // Track coords
    window.addEventListener("mousemove", onPointerMove, {passive:true});
    window.addEventListener("touchmove", onPointerMove, {passive:true});

    // Close menu on click elsewhere
    window.addEventListener("mousedown", (e)=>{
      if (menu.style.display === "block" && !menu.contains(e.target)) hideMenu();
    });
    window.addEventListener("blur", hideMenu);
    window.addEventListener("resize", hideMenu);

    // Menu actions
    addNoteBtn.addEventListener("click", ()=> openCreateModal("note"));
    addLibBtn.addEventListener("click", ()=>{
      if (libraryCredits<=0){ toast("K√ºt√ºphane hakkƒ±n kalmadƒ±"); return; }
      openCreateModal("library");
    });

    // Modal actions
    const closeAllCreate = ()=>{ closeCreateModal(); };
    closeModal.addEventListener("click", closeAllCreate);
    cancelBtn.addEventListener("click", closeAllCreate);
    modalOverlay.addEventListener("mousedown", (e)=>{ if (e.target === modalOverlay) closeAllCreate(); });

    async function doSave(){
      const type = pendingType;
      if (type === "library" && libraryCredits<=0){ toast("K√ºt√ºphane hakkƒ±n yok"); return; }

      // Optimistic: reserve credit before request
      const reserved = (type === "library");
      if (reserved) setCredits(libraryCredits - 1);

      saveBtn.disabled = true;
      const ok = await createItem(type, inputT.value, inputC.value, ctxWorld.x, ctxWorld.y);
      saveBtn.disabled = false;

      if (!ok && reserved) setCredits(libraryCredits + 1); // revert
      if (ok){
        closeCreateModal();
        toast(type === "library" ? "K√ºt√ºphane eklendi" : "Not eklendi");
      }
    }

    saveBtn.addEventListener("click", doSave);
    inputC.addEventListener("keydown", (e)=>{ if ((e.ctrlKey||e.metaKey) && e.key === "Enter") doSave(); });

    // Admin
    gear.addEventListener("click", openAdmin);
    closeAdmin.addEventListener("click", closeAdminModal);
    adminCancel.addEventListener("click", closeAdminModal);
    adminOverlay.addEventListener("mousedown", (e)=>{ if (e.target === adminOverlay) closeAdminModal(); });

    function tryAdmin(){
      if (pw.value === "Hasan0245"){
        setAdmin(true);
        toast("Admin mod aktif");
        closeAdminModal();
      } else {
        setAdmin(false);
        toast("≈ûifre yanlƒ±≈ü");
      }
    }
    adminOk.addEventListener("click", tryAdmin);
    pw.addEventListener("keydown", (e)=>{ if (e.key === "Enter") tryAdmin(); });

    // Keyboard shortcuts
    window.addEventListener("keydown", (e)=>{
      if (e.key === "Escape"){
        hideMenu();
        closeCreateModal();
        closeAdminModal();
      }
    });

    // Initial placement: center origin roughly in view
    function center(){
      const r = boardWrap.getBoundingClientRect();
      camX = Math.round(r.width/2);
      camY = Math.round(r.height/2);
      applyTransform();
    }

    // Boot
    center();
    await loadItems();
    subscribeRealtime();

    // If Supabase is blocked by CORS/adblock, show hint
    setTimeout(()=>{
      if (items.size === 0) {
        // Not necessarily empty DB ‚Äî only a gentle note
        console.log("Loaded 0 items (could be empty table or RLS)." );
      }
    }, 1200);

  </script>
</body>
</html>
