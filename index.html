<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Leave a Note | Stable Focus</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root { --p: #00ff88; --bg: #010101; --grid: rgba(255, 255, 255, 0.05); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: sans-serif; }

        /* --- STABILIZED VIEWPORT --- */
        #viewport { width: 100vw; height: 100vh; position: relative; overflow: hidden; cursor: crosshair; }
        
        #camera {
            position: absolute;
            width: 100000px; height: 100000px;
            background-image: 
                linear-gradient(var(--grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 100px 100px;
            transform-origin: 0 0; /* Hesaplamalar i√ßin 0,0'da kalmalƒ± */
            will-change: transform;
            /* Transition zoom sƒ±rasƒ±nda kapatƒ±lmalƒ±, yoksa titreme yapar */
        }

        /* --- UI & HUD --- */
        #hud {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 100; display: flex; gap: 10px; pointer-events: none;
        }
        .hud-item { background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 20px; color: #fff; font-size: 12px; border: 1px solid #333; }
        .hud-item span { color: var(--p); font-weight: bold; }

        /* --- NOTES --- */
        .note {
            position: absolute; padding: 15px; background: #111; border: 1px solid #333;
            border-radius: 10px; color: #fff; min-width: 150px; pointer-events: all;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        #ctx { position: fixed; display: none; background: #222; border: 1px solid var(--p); border-radius: 5px; padding: 5px; z-index: 1000; }
        .ctx-item { padding: 8px 15px; color: #fff; cursor: pointer; border-radius: 3px; font-size: 13px; }
        .ctx-item:hover { background: var(--p); color: #000; }
    </style>
</head>
<body>

<div id="hud">
    <div class="hud-item">POS: <span id="pos-display">0, 0</span></div>
    <div class="hud-item">ZOOM: <span id="zoom-display">100%</span></div>
</div>

<div id="ctx"><div class="ctx-item" onclick="Engine.openModal()">üìù Buraya Not Bƒ±rak</div></div>

<div id="viewport">
    <div id="camera">
        <div style="position:absolute; left:50000px; top:50000px; color:var(--p); font-weight:bold; font-size:40px; transform:translate(-50%,-50%); border:2px solid var(--p); padding:20px; border-radius:50%">CENTER (SPAWN)</div>
    </div>
</div>

<script>
const Engine = {
    config: {
        SB_URL: "https://ssfgvjudifodfhovhpzx.supabase.co",
        SB_KEY: "sb_publishable_hBGvHNaGoHd_5cLAKVUhqA_N87pXWQo",
        CENTER: 50000
    },

    state: {
        db: null,
        x: 0, y: 0, scale: 1,
        isDragging: false,
        lastMouse: { x: 0, y: 0 },
        clickCoord: { x: 0, y: 0 }
    },

    init: async function() {
        this.state.db = supabase.createClient(this.config.SB_URL, this.config.SB_KEY);
        
        // ƒ∞lk a√ßƒ±lƒ±≈üta ekran ortasƒ±nƒ± merkeze kilitler
        this.state.x = -(this.config.CENTER) + (window.innerWidth / 2);
        this.state.y = -(this.config.CENTER) + (window.innerHeight / 2);

        this.bindEvents();
        this.loadNotes();
        this.update();
    },

    bindEvents: function() {
        const cam = document.getElementById('camera');

        // --- S√úR√úKLEME MEKANƒ∞ƒûƒ∞ ---
        window.onmousedown = (e) => {
            if(e.button === 0) {
                this.state.isDragging = true;
                this.state.lastMouse = { x: e.clientX, y: e.clientY };
                cam.style.transition = "none"; // S√ºr√ºklerken animasyon olmasƒ±n
            }
        };

        window.onmousemove = (e) => {
            if (this.state.isDragging) {
                this.state.x += e.clientX - this.state.lastMouse.x;
                this.state.y += e.clientY - this.state.lastMouse.y;
                this.state.lastMouse = { x: e.clientX, y: e.clientY };
                this.update();
            }
            
            // Koordinat Takibi
            const wx = Math.round((e.clientX - this.state.x) / this.state.scale);
            const wy = Math.round((e.clientY - this.state.y) / this.state.scale);
            document.getElementById('pos-display').innerText = `${wx}, ${wy}`;
        };

        window.onmouseup = () => this.state.isDragging = false;

        // --- D√úZELTƒ∞LMƒ∞≈û HASSAS ZOOM ---
        window.onwheel = (e) => {
            e.preventDefault();
            cam.style.transition = "none"; // Zoom anlƒ±k olmalƒ±

            const zoomSpeed = 0.02; // √áok k√º√ß√ºk adƒ±m
            const delta = e.deltaY > 0 ? -zoomSpeed : zoomSpeed;
            
            const oldScale = this.state.scale;
            const newScale = Math.min(Math.max(0.2, oldScale + delta), 2.5);

            // ZOOM ODAK NOKTASI: Ekranƒ±n tam ortasƒ±
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            // Koordinat stabilizasyon form√ºl√º
            this.state.x = centerX - (centerX - this.state.x) * (newScale / oldScale);
            this.state.y = centerY - (centerY - this.state.y) * (newScale / oldScale);
            
            this.state.scale = newScale;
            this.update();
        };

        // SAƒû TIK
        window.oncontextmenu = (e) => {
            e.preventDefault();
            this.state.clickCoord = {
                x: Math.round((e.clientX - this.state.x) / this.state.scale),
                y: Math.round((e.clientY - this.state.y) / this.state.scale)
            };
            const menu = document.getElementById('ctx');
            menu.style.display = 'block';
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
        };

        window.onclick = () => document.getElementById('ctx').style.display = 'none';
    },

    update: function() {
        const cam = document.getElementById('camera');
        cam.style.transform = `translate(${this.state.x}px, ${this.state.y}px) scale(${this.state.scale})`;
        document.getElementById('zoom-display').innerText = Math.round(this.state.scale * 100) + "%";
    },

    openModal: function() {
        const title = prompt("Not Ba≈ülƒ±ƒüƒ±:");
        const body = prompt("Not ƒ∞√ßeriƒüi:");
        if (title && body) this.saveNote(title, body);
    },

    saveNote: async function(t, b) {
        const { error } = await this.state.db.from('items').insert([{
            title: t, content: b, 
            x: this.state.clickCoord.x, 
            y: this.state.clickCoord.y
        }]);
        if(!error) location.reload();
    },

    loadNotes: async function() {
        const { data } = await this.state.db.from('items').select('*');
        data?.forEach(n => {
            const div = document.createElement('div');
            div.className = 'note';
            div.style.left = n.x + 'px';
            div.style.top = n.y + 'px';
            div.innerHTML = `<strong>${n.title}</strong><br>${n.content}`;
            document.getElementById('camera').appendChild(div);
        });
    }
};

Engine.init();
</script>
</body>
</html>
